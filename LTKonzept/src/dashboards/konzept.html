<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lager-Zuteilungscockpit (Canvas Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        canvas {
            width: 100%;
            height: 100%;
        }
        @keyframes fadeInScale {
            from { 
                opacity: 0;
                transform: scale(0.95) translateX(-10px);
            }
            to { 
                opacity: 1;
                transform: scale(1) translateX(0);
            }
        }
        .dragging {
            opacity: 0.5;
            cursor: grabbing !important;
        }
        .drag-over {
            background-color: #e0f2fe !important;
            border: 2px dashed #3b82f6 !important;
        }
        .draggable-handle {
            cursor: grab;
            transition: transform 0.2s;
            color: #3b82f6;
            font-weight: 600;
        }
        .draggable-handle:hover {
            transform: translateX(2px);
            text-decoration: underline;
            color: #2563eb;
        }
        .draggable-handle:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="flex h-screen">
        <!-- Sidebar (unchanged from original) -->
        <aside class="sidebar bg-slate-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-20">
            <div class="text-white flex items-center space-x-2 px-2">
                <span class="text-2xl font-extrabold">Lager-Cockpit</span>
            </div>
            <nav>
                <a href="#" id="nav-dashboard" onclick="showDashboard()" class="nav-item flex items-center space-x-3 bg-blue-500 bg-opacity-30 text-white py-2 px-4 rounded transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    <span>Dashboard</span>
                </a>
                 <a href="#" id="nav-cases" onclick="showCaseManagement()" class="nav-item flex items-center space-x-3 hover:bg-slate-700 py-2 px-4 rounded transition duration-200">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                     <span>Lieferscheine</span>
                 </a>
                 <a href="#" id="nav-employees" onclick="showEmployeeManagement()" class="nav-item flex items-center space-x-3 hover:bg-slate-700 py-2 px-4 rounded transition duration-200">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                     <span>Mitarbeiter</span>
                 </a>
                 <a href="#" id="nav-sketch" onclick="showTechnicalSketch()" class="nav-item flex items-center space-x-3 hover:bg-slate-700 py-2 px-4 rounded transition duration-200">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                     <span>Technische Skizze</span>
                 </a>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="main-content flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
                <button class="md:hidden" id="menu-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-gray-700">Lager-Zuteilungscockpit</h1>
                <div class="flex items-center space-x-4">
                    <!-- Referenz-Dashboard Button -->
                    <a href="/src/presentations/referenz.html" class="bg-purple-500 bg-opacity-10 hover:bg-opacity-20 text-purple-600 px-4 py-2 rounded-lg transition-all duration-300 flex items-center space-x-2 border border-purple-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm font-medium">Referenz-Projekte</span>
                    </a>
                    <span class="text-sm">Hallo, Frau Schumann</span>
                    <img class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/100x100/E2E8F0/4A5568?text=MW" alt="User Avatar">
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <canvas id="dashboardCanvas"></canvas>
            </main>
        </div>
    </div>
<script>
    // --- Mock Data --- 
    // (Same data as in the previous example)
    const mitarbeiterData = [
        // Neuling
        { id: 1, name: "Anna Schmidt", status: "Verfügbar", position: "neuling", employmentType: "vollzeit", abteilung: "Allgemein", workload: 320, maxWorkload: 480, skills: ["Empfindliche Textilien", "Schuhe"], avatar: "AS", casesToday: 12, avgTime: 45 },
        { id: 2, name: "Bernd Maier", status: "Verfügbar", position: "neuling", employmentType: "teilzeit", abteilung: "Allgemein", workload: 180, maxWorkload: 300, skills: ["Schuhe", "Lederwaren"], avatar: "BM", casesToday: 10, avgTime: 48 },
        { id: 12, name: "Lisa Müller", status: "Verfügbar", position: "neuling", employmentType: "minijob", abteilung: "Allgemein", workload: 90, maxWorkload: 210, skills: ["Kleinteilige Ware", "Schuhe"], avatar: "LM", casesToday: 5, avgTime: 50 },
        { id: 15, name: "Oliver Schmidt", status: "Verfügbar", position: "neuling", employmentType: "teilzeit", abteilung: "Allgemein", workload: 160, maxWorkload: 300, skills: ["Glas & Porzellan", "Kleinteilige Ware"], avatar: "OS", casesToday: 8, avgTime: 46 },

        // Normal
        { id: 3, name: "Carla Huber", status: "Beschäftigt", position: "normal", employmentType: "vollzeit", abteilung: "Allgemein", workload: 400, maxWorkload: 480, skills: ["Empfindliche Textilien", "Schwere Artikel"], avatar: "CH", casesToday: 9, avgTime: 35 },
        { id: 4, name: "David Fuchs", status: "Verfügbar", position: "normal", employmentType: "vollzeit", abteilung: "Allgemein", workload: 200, maxWorkload: 480, skills: ["Lederwaren", "Empfindliche Textilien"], avatar: "DF", isNew: true, casesToday: 15, avgTime: 32 },
        { id: 5, name: "Eva Klein", status: "Verfügbar", position: "normal", employmentType: "teilzeit", abteilung: "Allgemein", workload: 0, maxWorkload: 300, skills: ["Schuhe", "Schwere Artikel"], avatar: "EK", casesToday: 12, avgTime: 38 },
        { id: 9, name: "Ina Becker", status: "Verfügbar", position: "normal", employmentType: "minijob", abteilung: "Allgemein", workload: 120, maxWorkload: 210, skills: ["Glas & Porzellan", "Parfüm & Kosmetik"], avatar: "IB", casesToday: 6, avgTime: 40 },
        { id: 13, name: "Max Weber", status: "Verfügbar", position: "normal", employmentType: "vollzeit", abteilung: "Allgemein", workload: 380, maxWorkload: 480, skills: ["Empfindliche Textilien", "Lederwaren"], avatar: "MW", casesToday: 11, avgTime: 33 },
        { id: 16, name: "Paula Klein", status: "Verfügbar", position: "normal", employmentType: "minijob", abteilung: "Allgemein", workload: 140, maxWorkload: 210, skills: ["Schuhe"], avatar: "PK", casesToday: 4, avgTime: 42 },
        { id: 17, name: "Robert Wagner", status: "Verfügbar", position: "normal", employmentType: "vollzeit", abteilung: "Allgemein", workload: 340, maxWorkload: 480, skills: ["Empfindliche Textilien", "Kleinteilige Ware"], avatar: "RW", casesToday: 13, avgTime: 34 },
        { id: 18, name: "Sabine Hoffmann", status: "Verfügbar", position: "normal", employmentType: "vollzeit", abteilung: "Allgemein", workload: 410, maxWorkload: 480, skills: ["Lederwaren", "Schwere Artikel"], avatar: "SH", casesToday: 14, avgTime: 36 },
        { id: 19, name: "Thomas Bauer", status: "Verfügbar", position: "normal", employmentType: "teilzeit", abteilung: "Allgemein", workload: 160, maxWorkload: 300, skills: ["Schuhe", "Lederwaren"], avatar: "TB", casesToday: 9, avgTime: 37 },
        { id: 20, name: "Ursula Schulz", status: "Verfügbar", position: "normal", employmentType: "vollzeit", abteilung: "Allgemein", workload: 360, maxWorkload: 480, skills: ["Glas & Porzellan", "Zerbrechliche Deko-Artikel"], avatar: "US", casesToday: 12, avgTime: 35 },
        { id: 21, name: "Viktor Lang", status: "Verfügbar", position: "normal", employmentType: "minijob", abteilung: "Allgemein", workload: 140, maxWorkload: 210, skills: ["Empfindliche Textilien"], avatar: "VL", casesToday: 5, avgTime: 41 },
        { id: 22, name: "Wanda Peters", status: "Verfügbar", position: "normal", employmentType: "teilzeit", abteilung: "Allgemein", workload: 180, maxWorkload: 300, skills: ["Lederwaren"], avatar: "WP", casesToday: 10, avgTime: 39 },
        { id: 23, name: "Xaver Braun", status: "Verfügbar", position: "normal", employmentType: "vollzeit", abteilung: "Allgemein", workload: 430, maxWorkload: 480, skills: ["Schwere Artikel", "Kleinteilige Ware"], avatar: "XB", casesToday: 11, avgTime: 33 },
        { id: 24, name: "Yvonne Wolf", status: "Verfügbar", position: "normal", employmentType: "vollzeit", abteilung: "Allgemein", workload: 380, maxWorkload: 480, skills: ["Empfindliche Textilien", "Parfüm & Kosmetik"], avatar: "YW", casesToday: 13, avgTime: 34 },
        { id: 25, name: "Zacharias Krüger", status: "Verfügbar", position: "normal", employmentType: "teilzeit", abteilung: "Allgemein", workload: 200, maxWorkload: 300, skills: ["Schuhe", "Schwere Artikel"], avatar: "ZK", casesToday: 10, avgTime: 38 },

        // Experte
        { id: 6, name: "Frank Nagel", status: "Verfügbar", position: "experte", employmentType: "vollzeit", abteilung: "Allgemein", workload: 350, maxWorkload: 480, skills: ["Empfindliche Textilien", "Glas & Porzellan", "Parfüm & Kosmetik"], avatar: "FN", casesToday: 18, avgTime: 25 },
        { id: 7, name: "Gabi Lorenz", status: "Verfügbar", position: "experte", employmentType: "vollzeit", abteilung: "Allgemein", workload: 120, maxWorkload: 480, skills: ["Lederwaren", "Empfindliche Textilien"], avatar: "GL", casesToday: 16, avgTime: 28 },
        { id: 10, name: "Julia Weiss", status: "Verfügbar", position: "experte", employmentType: "teilzeit", abteilung: "Allgemein", workload: 160, maxWorkload: 300, skills: ["Glas & Porzellan", "Zerbrechliche Deko-Artikel"], avatar: "JW", casesToday: 14, avgTime: 26 },
        { id: 14, name: "Nina Fischer", status: "Verfügbar", position: "experte", employmentType: "vollzeit", abteilung: "Allgemein", workload: 390, maxWorkload: 480, skills: ["Schwere Artikel", "Empfindliche Textilien"], avatar: "NF", casesToday: 16, avgTime: 24 },
        { id: 8, name: "Hans Richter", status: "Verfügbar", position: "experte", employmentType: "vollzeit", abteilung: "Allgemein", workload: 280, maxWorkload: 480, skills: ["Glas & Porzellan", "Zerbrechliche Deko-Artikel", "Parfüm & Kosmetik"], avatar: "HR", casesToday: 8, avgTime: 20 },
        { id: 11, name: "Karl Meyer", status: "Verfügbar", position: "experte", employmentType: "vollzeit", abteilung: "Allgemein", workload: 340, maxWorkload: 480, skills: ["Empfindliche Textilien", "Lederwaren", "Glas & Porzellan"], avatar: "KM", casesToday: 6, avgTime: 18 },
    ];

    const manuelleLieferscheine = [
        { id: "LS-98345", type: "Oberbekleidung", amount: 280, reason: "Eillieferung - hohe Priorität" },
        { id: "LS-98349", type: "Textilien", amount: 450, reason: "Großlieferung - mehrere Paletten" },
        { id: "LS-98351", type: "Schuhe & Taschen", amount: 120, reason: "Zerbrechliche Ware - Vorsicht" },
        { id: "LS-98355", type: "Accessoires", amount: 85, reason: "Qualitätskontrolle erforderlich" },
    ];
     
    let letzteZuweisungenData = [
        { time: "16:18", id: "LS-2024-0854", type: "Textilien", mitarbeiter: "Anna Schmidt", status: "In Bearbeitung", items: 32},
        { time: "16:15", id: "LS-2024-0853", type: "Schuhe", mitarbeiter: "Bernd Maier", status: "Zugewiesen", items: 45},
        { time: "16:11", id: "LS-2024-0852", type: "Accessoires", mitarbeiter: "David Fuchs", status: "Abgeschlossen", items: 18},
        { time: "16:05", id: "LS-2024-0850", type: "Oberbekleidung", mitarbeiter: "Anna Schmidt", status: "In Bearbeitung", items: 56},
    ];

    let kpiData = {
        neueLieferscheine: 124,
        automatisch: 118,
        manuell: 6,
    };


    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('dashboardCanvas');
        const ctx = canvas.getContext('2d');

        // --- Style & Layout Constants ---
        const theme = {
            colors: {
                bg: '#F0F2F5',
                cardBg: '#FFFFFF',
                text: '#374151',
                textLight: '#6B7280',
                textHeading: '#1F2937',
                shadow: 'rgba(0, 0, 0, 0.1)',
                blue: '#3B82F6', blueLight: '#DBEAFE',
                green: '#10B981', greenLight: '#D1FAE5',
                orange: '#F97316', orangeLight: '#FFEDD5',
                indigo: '#6366F1', indigoLight: '#E0E7FF',
                yellow: '#F59E0B',
                red: '#EF4444',
                slate: '#64748B', slateLight: '#F1F5F9',
                border: '#E5E7EB',
            },
            padding: 24,
            gap: 24,
        };

        // --- Helper functions ---
        function drawRoundedRect(x, y, width, height, radius, color, shadow = false) {
            ctx.fillStyle = color;
            if (shadow) {
                ctx.shadowColor = theme.colors.shadow;
                ctx.shadowBlur = 15;
                ctx.shadowOffsetY = 4;
            }
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
            // Reset shadow
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;
        }

        function drawIcon(iconName, x, y, size, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = size / 10;
            ctx.beginPath();
            switch(iconName) {
                case 'new_case': // Plus in a document
                    ctx.moveTo(x + size * 0.2, y + size * 0.1);
                    ctx.lineTo(x + size * 0.8, y + size * 0.1);
                    ctx.lineTo(x + size * 0.8, y + size * 0.9);
                    ctx.lineTo(x + size * 0.2, y + size * 0.9);
                    ctx.closePath();
                    ctx.moveTo(x + size * 0.5, y + size * 0.3);
                    ctx.lineTo(x + size * 0.5, y + size * 0.7);
                    ctx.moveTo(x + size * 0.3, y + size * 0.5);
                    ctx.lineTo(x + size * 0.7, y + size * 0.5);
                    break;
                case 'auto_assign': // Check in a gear
                    ctx.arc(x + size / 2, y + size / 2, size * 0.4, 0, Math.PI * 2);
                    ctx.moveTo(x + size * 0.4, y + size * 0.5);
                    ctx.lineTo(x + size * 0.5, y + size * 0.6);
                    ctx.lineTo(x + size * 0.7, y + size * 0.4);
                    break;
                case 'manual_review': // Exclamation in a circle
                    ctx.arc(x + size / 2, y + size / 2, size * 0.45, 0, Math.PI * 2);
                    ctx.moveTo(x + size / 2, y + size * 0.3);
                    ctx.lineTo(x + size / 2, y + size * 0.6);
                    ctx.moveTo(x + size / 2, y + size * 0.75);
                    ctx.lineTo(x + size / 2, y + size * 0.8);
                    break;
                case 'available_staff': // Group of people
                    ctx.arc(x + size * 0.5, y + size * 0.4, size * 0.15, 0, Math.PI * 2);
                    ctx.moveTo(x + size * 0.3, y + size * 0.9);
                    ctx.quadraticCurveTo(x + size * 0.5, y + size * 0.6, x + size * 0.7, y + size * 0.9);
                    break;
            }
            ctx.stroke();
        }

        // --- Main Drawing Functions ---
        function drawKPIs(x, y, width) {
            const cardCount = 2;
            const cardWidth = (width - (cardCount - 1) * theme.gap) / cardCount;
            const cardHeight = 110;
            
            const cards = [
                { title: 'Neue Lieferungen', value: kpiData.neueLieferungen, color: theme.colors.blue, lightColor: theme.colors.blueLight, icon: 'new_case' },
                { title: 'Artikel heute', value: kpiData.artikelHeute, color: theme.colors.green, lightColor: theme.colors.greenLight, icon: 'auto_assign' }
            ];

            cards.forEach((card, i) => {
                const cardX = x + i * (cardWidth + theme.gap);
                drawRoundedRect(cardX, y, cardWidth, cardHeight, 10, theme.colors.cardBg, true);
                
                // Content
                ctx.fillStyle = theme.colors.textLight;
                ctx.font = '14px Inter';
                ctx.fillText(card.title, cardX + 20, y + 35);

                ctx.fillStyle = card.color === theme.colors.orange ? theme.colors.orange : theme.colors.textHeading;
                ctx.font = 'bold 30px Inter';
                ctx.fillText(card.value, cardX + 20, y + 75);

                // Icon
                drawRoundedRect(cardX + cardWidth - 60, y + 20, 40, 40, 20, card.lightColor);
                drawIcon(card.icon, cardX + cardWidth - 52, y + 28, 24, card.color);
            });

            return cardHeight; // Return the height of this section
        }
        
        function drawManualCases(x, y, width, height) {
            drawRoundedRect(x, y, width, height, 10, theme.colors.cardBg, true);
            const p = 24; // padding

            ctx.fillStyle = theme.colors.textHeading;
            ctx.font = 'bold 20px Inter';
            ctx.fillText('Lieferscheine zur Zuweisung', x + p, y + p + 10);

            // Table Header
            const headers = ['Lieferschein', 'Warengruppe', 'Artikel', 'Priorität', 'Aktion'];
            const colWidths = [0.2, 0.2, 0.2, 0.25, 0.15];
            ctx.font = '600 14px Inter';
            ctx.fillStyle = theme.colors.textLight;
            let currentX = x + p;
            headers.forEach((header, i) => {
                ctx.fillText(header, currentX, y + 70);
                currentX += colWidths[i] * (width - 2 * p);
            });

            // Table Rows
            const rowHeight = 50;
            manuelleFaelleData.forEach((fall, i) => {
                const rowY = y + 85 + i * rowHeight;
                // Draw bottom border
                ctx.strokeStyle = theme.colors.border;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x + p, rowY + rowHeight - 1);
                ctx.lineTo(x + width - p, rowY + rowHeight - 1);
                ctx.stroke();

                let cellX = x + p;
                // Lieferschein-ID
                ctx.font = '14px "Courier New", monospace';
                ctx.fillStyle = theme.colors.text;
                ctx.fillText(fall.id, cellX, rowY + 28);
                cellX += colWidths[0] * (width - 2 * p);
                // Warengruppe
                ctx.font = '14px Inter';
                ctx.fillText(fall.type, cellX, rowY + 28);
                cellX += colWidths[1] * (width - 2 * p);
                // Artikel
                ctx.fillText(`${fall.items} Artikel`, cellX, rowY + 28);
                cellX += colWidths[2] * (width - 2 * p);
                // Priorität
                const priorityColors = {
                    'Hoch': { bg: theme.colors.red + '20', text: theme.colors.red },
                    'Mittel': { bg: theme.colors.orangeLight, text: theme.colors.orange },
                    'Niedrig': { bg: theme.colors.greenLight, text: theme.colors.green }
                };
                const pColor = priorityColors[fall.priority] || priorityColors['Mittel'];
                drawRoundedRect(cellX, rowY + 16, ctx.measureText(fall.priority).width + 20, 24, 12, pColor.bg);
                ctx.fillStyle = pColor.text;
                ctx.font = '500 12px Inter';
                ctx.fillText(fall.priority, cellX + 10, rowY + 32);
                cellX += colWidths[3] * (width - 2 * p);
                // Aktion Button
                drawRoundedRect(cellX + (colWidths[4] * (width - 2 * p) / 2) - 45 , rowY + 16, 90, 28, 6, theme.colors.blue);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 13px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Zuweisen', cellX + (colWidths[4] * (width - 2 * p) / 2), rowY + 35);
                ctx.textAlign = 'left';

            });
        }
        
        function drawEmployeeUtilization(x, y, width, height) {
             drawRoundedRect(x, y, width, height, 10, theme.colors.cardBg, true);
             const p = 24; // padding

            ctx.fillStyle = theme.colors.textHeading;
            ctx.font = 'bold 20px Inter';
            ctx.fillText('Paketauspacker-Zuteilung', x + p, y + p + 10);
            
            const itemHeight = 90;
            mitarbeiterData.forEach((m, i) => {
                const itemY = y + 60 + i * itemHeight;

                // Avatar
                drawRoundedRect(x + p, itemY, 40, 40, 20, theme.colors.slateLight);
                ctx.fillStyle = theme.colors.slate;
                ctx.font = 'bold 14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(m.avatar, x + p + 20, itemY + 26);
                ctx.textAlign = 'left';

                // Name & Skills
                ctx.fillStyle = theme.colors.textHeading;
                ctx.font = '600 15px Inter';
                ctx.fillText(m.name, x + p + 55, itemY + 18);
                if (m.isNew) {
                    ctx.fillStyle = theme.colors.blue;
                    ctx.font = '12px Inter';
                    ctx.fillText('(Neu)', x + p + 55 + ctx.measureText(m.name).width + 5, itemY + 17);
                }

                let skillX = x + p + 55;
                m.skills.forEach(skill => {
                    drawRoundedRect(skillX, itemY + 25, ctx.measureText(skill).width + 12, 18, 5, theme.colors.slateLight);
                    ctx.fillStyle = theme.colors.slate;
                    ctx.font = '11px Inter';
                    ctx.fillText(skill, skillX + 6, itemY + 38);
                    skillX += ctx.measureText(skill).width + 18;
                });

                // Status Badge
                const statusColors = { 'Verfügbar': {bg: theme.colors.greenLight, text: theme.colors.green}, 'Beschäftigt': {bg: theme.colors.yellow, text: '#FFFFFF'}, 'Urlaub': {bg: theme.colors.slateLight, text: theme.colors.slate}, 'Krank': {bg: theme.colors.red, text: '#FFFFFF'} };
                const statusColor = statusColors[m.status] || {bg: theme.colors.slateLight, text: theme.colors.slate};
                const statusWidth = ctx.measureText(m.status).width + 20;
                drawRoundedRect(x + width - p - statusWidth, itemY + 10, statusWidth, 24, 12, statusColor.bg);
                ctx.fillStyle = statusColor.text;
                ctx.font = '500 12px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(m.status, x + width - p - statusWidth / 2, itemY + 26);
                ctx.textAlign = 'left';

                // Workload Bar
                const percentage = (m.workload / m.maxWorkload) * 100;
                let barColor = theme.colors.green;
                if (percentage >= 85) barColor = theme.colors.red;
                else if (percentage >= 50) barColor = theme.colors.yellow;
                
                drawRoundedRect(x + p, itemY + 70, width - 2 * p, 8, 4, theme.colors.slateLight);
                drawRoundedRect(x + p, itemY + 70, (width - 2 * p) * (percentage / 100), 8, 4, barColor);
                
                ctx.fillStyle = theme.colors.textLight;
                ctx.font = '12px Inter';
                ctx.fillText('Auslastung', x + p, itemY + 60);
                ctx.textAlign = 'right';
                ctx.fillText(`${m.workload}/${m.maxWorkload} Min`, x + width - p, itemY + 60);
                ctx.textAlign = 'left';
            });
        }
        
        function drawRecentAssignments(x, y, width, height, highlight) {
            drawRoundedRect(x, y, width, height, 10, theme.colors.cardBg, true);
            const p = 24; // padding

            ctx.fillStyle = theme.colors.textHeading;
            ctx.font = 'bold 20px Inter';
            ctx.fillText('Letzte Lieferschein-Zuweisungen', x + p, y + p + 10);
            
            // Header
            const headers = ['Zeit', 'Lieferschein', 'Warengruppe', 'Auspacker', 'Status'];
            const colWidths = [0.1, 0.2, 0.25, 0.25, 0.2];
            ctx.font = '600 14px Inter';
            ctx.fillStyle = theme.colors.textLight;
            let currentX = x + p;
            headers.forEach((header, i) => {
                ctx.fillText(header, currentX, y + 70);
                currentX += colWidths[i] * (width - 2 * p);
            });

            // Rows
            const rowHeight = 45;
             letzteZuweisungenData.slice(0, 5).forEach((zuweisung, i) => {
                const rowY = y + 80 + i * rowHeight;

                if (highlight && i === 0) {
                     drawRoundedRect(x + 5, rowY - 5, width - 10, rowHeight, 5, theme.colors.blueLight);
                }
                
                // Border
                ctx.strokeStyle = theme.colors.border;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x + p, rowY + rowHeight - 6);
                ctx.lineTo(x + width - p, rowY + rowHeight - 6);
                ctx.stroke();

                let cellX = x + p;
                ctx.fillStyle = theme.colors.textLight;
                ctx.font = '14px Inter';
                // Zeit
                ctx.fillText(zuweisung.time, cellX, rowY + 25);
                cellX += colWidths[0] * (width - 2 * p);
                // Lieferschein-ID
                ctx.fillStyle = theme.colors.text;
                ctx.font = '14px "Courier New", monospace';
                ctx.fillText(zuweisung.id, cellX, rowY + 25);
                cellX += colWidths[1] * (width - 2 * p);
                // Warengruppe + Artikel
                ctx.font = '14px Inter';
                ctx.fillText(`${zuweisung.type} (${zuweisung.items} Art.)`, cellX, rowY + 25);
                cellX += colWidths[2] * (width - 2 * p);
                // Auspacker
                ctx.fillText(zuweisung.mitarbeiter, cellX, rowY + 25);
                cellX += colWidths[3] * (width - 2 * p);
                // Status
                const statusColors = {
                    'Zugewiesen': { color: theme.colors.blue, text: '• Zugewiesen' },
                    'In Bearbeitung': { color: theme.colors.yellow, text: '▶ In Bearbeitung' },
                    'Abgeschlossen': { color: theme.colors.green, text: '✔ Abgeschlossen' }
                };
                const statusInfo = statusColors[zuweisung.status] || statusColors['Zugewiesen'];
                ctx.fillStyle = statusInfo.color;
                ctx.fillText(statusInfo.text, cellX, rowY + 25);

             });
        }
        

        // --- Main Render Loop ---
        let highlightNewRow = false;

        function draw() {
            // Clear canvas
            ctx.fillStyle = theme.colors.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const p = theme.padding;
            const gap = theme.gap;
            const totalWidth = canvas.width - 2 * p;

            // KPIs
            const kpiHeight = drawKPIs(p, p, totalWidth);
            const mainY = p + kpiHeight + gap;

            // Only draw KPI cards - removed other sections
        }

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            // Set a minimum height for the canvas's container based on content
            const isWide = window.innerWidth > 1024;
            const employeeListHeight = mitarbeiterData.length * 90 + 80;
            const mainGridHeight = 350;
            const recentAssignmentsHeight = 300;
            const kpiHeight = 110;

            let requiredHeight = theme.padding * 2 + kpiHeight + theme.gap;
            if(isWide) {
                requiredHeight += Math.max(employeeListHeight, mainGridHeight + theme.gap + recentAssignmentsHeight);
            } else {
                requiredHeight += mainGridHeight + theme.gap + employeeListHeight + theme.gap + recentAssignmentsHeight;
            }
            canvas.style.height = `${requiredHeight}px`;

            draw();
        }
        
        // --- Simulation ---
        function simulateNewCase() {
            kpiData.neueFaelle++;
            kpiData.automatisch++;

            const availableMitarbeiter = mitarbeiterData.filter(m => m.status === 'Verfügbar' && m.workload < m.maxWorkload);
            if (availableMitarbeiter.length === 0) return;
            
            const mitarbeiter = availableMitarbeiter[Math.floor(Math.random() * availableMitarbeiter.length)];
            mitarbeiter.workload++;

            const now = new Date();
            const time = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            const newCaseId = `LS-2024-${Math.floor(1000 + Math.random() * 9000)}`;
            const warengruppen = ["Textilien", "Schuhe", "Accessoires", "Oberbekleidung"];
            const randomType = warengruppen[Math.floor(Math.random() * warengruppen.length)];
            const randomItems = Math.floor(10 + Math.random() * 90);

            letzteZuweisungenData.unshift({
                time: time, id: newCaseId, type: randomType, mitarbeiter: mitarbeiter.name, status: "Zugewiesen", items: randomItems
            });
            if (letzteZuweisungenData.length > 10) letzteZuweisungenData.pop();
            
            highlightNewRow = true;
            draw();
            setTimeout(() => {
                highlightNewRow = false;
                draw();
            }, 1500);
        }


        // --- Initialisation ---
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        const menuButton = document.getElementById('menu-button');
        const sidebar = document.querySelector('.sidebar');
        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        setInterval(simulateNewCase, 5000);

        // Start with Employee Management view instead of Dashboard
        setTimeout(() => {
            showEmployeeManagement();
        }, 100);
    });

    // LocalStorage management
    function loadEmployeesFromStorage() {
        // Always return the hardcoded data with all properties
        return mitarbeiterData;
    }

    function saveEmployeeToStorage(employee) {
        let employees = loadEmployeesFromStorage();
        
        // Generate unique ID
        employee.id = Date.now();
        employee.avatar = employee.name.split(' ').map(n => n[0]).join('').toUpperCase();
        employee.workload = 0;
        employee.maxWorkload = 20;
        
        employees.push(employee);
        localStorage.setItem('gevEmployees', JSON.stringify(employees));
        return employees;
    }

    function updateSidebarNavigation(activeItem) {
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('bg-blue-500', 'bg-opacity-30');
            item.classList.add('hover:bg-slate-700');
        });
        
        // Add active class to selected item
        const activeNav = document.getElementById(activeItem);
        if (activeNav) {
            activeNav.classList.add('bg-blue-500', 'bg-opacity-30');
            activeNav.classList.remove('hover:bg-slate-700');
        }
    }

    // Employee Management Functions
    function showEmployeeManagement() {
        // Hide dashboard canvas
        document.getElementById('dashboardCanvas').style.display = 'none';

        // Hide case view
        const caseView = document.getElementById('case-management');
        if (caseView) {
            caseView.classList.add('hidden');
        }

        // Hide technical sketch
        const sketchView = document.getElementById('technical-sketch');
        if (sketchView) {
            sketchView.classList.add('hidden');
        }

        // Hide analytics dashboard
        const analyticsView = document.getElementById('analytics-dashboard');
        if (analyticsView) {
            analyticsView.classList.add('hidden');
        }
        
        // Show employee management view
        const employeeView = document.getElementById('employee-management');
        if (employeeView) {
            employeeView.classList.remove('hidden');
        } else {
            // Create employee management view if it doesn't exist
            createEmployeeManagementView();
        }
        
        // Update page title
        const pageTitle = document.querySelector('h1');
        if (pageTitle) {
            pageTitle.textContent = 'Mitarbeiterverwaltung';
        }
        
        // Update sidebar navigation
        updateSidebarNavigation('nav-employees');
        
        // Refresh employee list
        refreshEmployeeList();
    }

    function showDashboard() {
        // Hide dashboard canvas (no longer used)
        document.getElementById('dashboardCanvas').style.display = 'none';

        // Hide other views
        const employeeView = document.getElementById('employee-management');
        if (employeeView) {
            employeeView.classList.add('hidden');
        }
        const caseView = document.getElementById('case-management');
        if (caseView) {
            caseView.classList.add('hidden');
        }
        const sketchView = document.getElementById('technical-sketch');
        if (sketchView) {
            sketchView.classList.add('hidden');
        }
        
        // Show analytics dashboard
        const analyticsView = document.getElementById('analytics-dashboard');
        if (!analyticsView) {
            createAnalyticsDashboard();
        } else {
            analyticsView.classList.remove('hidden');
        }
        
        // Update page title
        const pageTitle = document.querySelector('h1');
        if (pageTitle) {
            pageTitle.textContent = 'Lager Analytics Dashboard';
        }
        
        // Update sidebar navigation
        updateSidebarNavigation('nav-dashboard');
    }

    function showCaseManagement() {
        // Hide dashboard canvas
        document.getElementById('dashboardCanvas').style.display = 'none';

        // Hide employee view
        const employeeView = document.getElementById('employee-management');
        if (employeeView) {
            employeeView.classList.add('hidden');
        }

        // Hide technical sketch
        const sketchView = document.getElementById('technical-sketch');
        if (sketchView) {
            sketchView.classList.add('hidden');
        }

        // Hide analytics dashboard
        const analyticsView = document.getElementById('analytics-dashboard');
        if (analyticsView) {
            analyticsView.classList.add('hidden');
        }
        
        // Show case management view
        const caseView = document.getElementById('case-management');
        if (caseView) {
            caseView.classList.remove('hidden');
            // Refresh employee list in case view
            refreshCaseEmployeeList();
        } else {
            // Create case management view if it doesn't exist
            createCaseManagementView();
            refreshCaseEmployeeList();
        }
        
        // Update page title
        const pageTitle = document.querySelector('h1');
        if (pageTitle) {
            pageTitle.textContent = 'Lieferscheinverwaltung';
        }
        
        // Update sidebar navigation
        updateSidebarNavigation('nav-cases');
    }

    function refreshEmployeeList() {
        const employees = loadEmployeesFromStorage();
        const tbody = document.getElementById('employee-list');
        if (!tbody) return;
        
        // Map position values to display labels
        const positionLabels = {
            'neuling': 'Neuling',
            'normal': 'Normal',
            'experte': 'Experte',
            'junior': 'Neuling',
            'lagerhelfer': 'Neuling',
            'lagerarbeiter': 'Normal',
            'sachbearbeiter': 'Normal',
            'senior': 'Experte'
        };
        
        tbody.innerHTML = employees.map(emp => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="h-10 w-10 flex-shrink-0 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">${emp.avatar}</div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${emp.name}</div>
                            ${emp.email ? `<div class="text-sm text-gray-500">${emp.email}</div>` : ''}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${emp.abteilung || (emp.skills ? emp.skills[0] : 'Standard')}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div>
                        <div class="text-sm font-semibold text-gray-900">${positionLabels[emp.position] || emp.position || 'Lagerarbeiter'}</div>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${(emp.spezialisierungen || emp.skills || []).map(skill => `
                                <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                                    ${skill}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        emp.status === 'aktiv' || emp.status === 'Verfügbar' ? 'bg-green-100 text-green-800' :
                        emp.status === 'Beschäftigt' ? 'bg-yellow-100 text-yellow-800' :
                        emp.status === 'urlaub' || emp.status === 'Urlaub' ? 'bg-gray-100 text-gray-800' :
                        'bg-red-100 text-red-800'
                    }">${emp.status || 'Verfügbar'}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: ${(emp.workload/emp.maxWorkload)*100}%"></div>
                        </div>
                        <span class="text-sm text-gray-600">${emp.workload}/${emp.maxWorkload} Min</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="editEmployee(${emp.id})" class="text-blue-600 hover:text-blue-900 mr-2">Bearbeiten</button>
                    <button onclick="deleteEmployee(${emp.id})" class="text-red-600 hover:text-red-900">Löschen</button>
                </td>
            </tr>
        `).join('');
        
        // Update employee count
        const countEl = document.getElementById('employee-count');
        if (countEl) {
            countEl.textContent = `${employees.length} Mitarbeiter`;
        }
    }

    function deleteEmployee(id) {
        if (confirm('Möchten Sie diesen Mitarbeiter wirklich löschen?')) {
            let employees = loadEmployeesFromStorage();
            employees = employees.filter(emp => emp.id !== id);
            localStorage.setItem('gevEmployees', JSON.stringify(employees));
            refreshEmployeeList();
        }
    }

    function editEmployee(id) {
        alert('Bearbeitungsfunktion wird in Kürze verfügbar sein.');
    }

    // Tags management
    let employeeTags = [];
    let isEditingTags = true; // Start in edit mode for new employee
    
    function handleTagInput(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const input = event.target;
            const tagValue = input.value.trim();
            if (tagValue && !employeeTags.includes(tagValue)) {
                addTag(tagValue);
                input.value = '';
            }
        }
    }
    
    function addTag(tagValue) {
        if (!employeeTags.includes(tagValue)) {
            employeeTags.push(tagValue);
            renderTags();
            updateTagsDisplay();
            updateTagSuggestions();
        }
    }
    
    function removeTag(tagValue) {
        employeeTags = employeeTags.filter(tag => tag !== tagValue);
        renderTags();
        updateTagsDisplay();
        updateTagSuggestions();
    }
    
    function updateTagSuggestions() {
        // Show/hide suggestion buttons based on selected tags
        const suggestionButtons = document.querySelectorAll('.tag-suggestion');
        suggestionButtons.forEach(button => {
            const tagName = button.getAttribute('data-tag');
            if (employeeTags.includes(tagName)) {
                button.classList.add('hidden');
            } else {
                button.classList.remove('hidden');
            }
        });
    }
    
    function renderTags() {
        const container = document.getElementById('tags-container');
        const input = document.getElementById('tags-input');
        
        // Clear existing tags but keep input
        const existingTags = container.querySelectorAll('.tag-item');
        existingTags.forEach(tag => tag.remove());
        
        // Add tags before input
        employeeTags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag-item inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm';
            tagElement.innerHTML = `
                ${tag}
                <button type="button" onclick="removeTag('${tag}')" class="ml-1 hover:text-blue-600">
                    <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            `;
            container.insertBefore(tagElement, input);
        });
    }
    
    function updateTagsDisplay() {
        const displayList = document.getElementById('tags-display-list');
        if (displayList) {
            displayList.innerHTML = '';
            if (employeeTags.length === 0) {
                displayList.innerHTML = '<span class="text-gray-500 text-xs italic">Keine Tags ausgewählt</span>';
            } else {
                employeeTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'inline-flex px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-medium';
                    tagElement.textContent = tag;
                    displayList.appendChild(tagElement);
                });
            }
        }
    }
    
    function finishTagsEdit() {
        isEditingTags = false;
        const displayContainer = document.getElementById('tags-display');
        const editContainer = document.getElementById('tags-edit');
        const finishBtn = document.getElementById('finish-tags-btn');
        const editBtn = document.getElementById('edit-tags-btn');
        
        // Switch to compact display mode
        displayContainer.classList.remove('hidden');
        editContainer.classList.add('hidden');
        finishBtn.classList.add('hidden');
        editBtn.classList.remove('hidden');
        
        updateTagsDisplay();
    }
    
    function toggleTagsEdit() {
        isEditingTags = true;
        const displayContainer = document.getElementById('tags-display');
        const editContainer = document.getElementById('tags-edit');
        const finishBtn = document.getElementById('finish-tags-btn');
        const editBtn = document.getElementById('edit-tags-btn');

        // Switch back to edit mode
        displayContainer.classList.add('hidden');
        editContainer.classList.remove('hidden');
        finishBtn.classList.remove('hidden');
        editBtn.classList.add('hidden');

        document.getElementById('tags-input').focus();
    }

    // Working hours functions
    function addTimeSlot(day) {
        const checkbox = document.getElementById(`workday_${day}`);
        const container = document.getElementById(`timeslots_${day}`);

        // Enable the day if not already enabled
        if (!checkbox.checked) {
            checkbox.checked = true;
            container.classList.remove('hidden');
        }

        // Create new time slot
        const timeSlotDiv = document.createElement('div');
        timeSlotDiv.className = 'flex gap-2 items-center';
        timeSlotDiv.innerHTML = `
            <input type="time" class="px-2 py-1 border border-gray-300 rounded" data-day="${day}" data-type="start" placeholder="Von">
            <span class="text-gray-500">-</span>
            <input type="time" class="px-2 py-1 border border-gray-300 rounded" data-day="${day}" data-type="end" placeholder="Bis">
            <button type="button" onclick="removeTimeSlot(this)" class="text-red-500 hover:text-red-700">
                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        `;
        container.appendChild(timeSlotDiv);
    }

    function removeTimeSlot(button) {
        const timeSlotDiv = button.parentElement;
        const container = timeSlotDiv.parentElement;
        timeSlotDiv.remove();

        // If no more time slots, uncheck the day
        if (container.children.length === 0) {
            const day = container.id.replace('timeslots_', '');
            const checkbox = document.getElementById(`workday_${day}`);
            checkbox.checked = false;
            container.classList.add('hidden');
        }
    }

    function setupWorkingHoursVisibility() {
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];

        // Setup checkbox listeners for each day
        days.forEach(day => {
            const checkbox = document.getElementById(`workday_${day}`);
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    const container = document.getElementById(`timeslots_${day}`);
                    if (this.checked) {
                        container.classList.remove('hidden');
                        // Add default time slot if none exists
                        if (container.children.length === 0) {
                            addTimeSlot(day);
                        }
                    } else {
                        container.classList.add('hidden');
                    }
                });
            }
        });

        // Show/hide working hours section based on employment type
        const employmentTypeSelect = document.getElementById('emp_employment_type');
        if (employmentTypeSelect) {
            employmentTypeSelect.addEventListener('change', function() {
                const workingHoursSection = document.getElementById('working-hours-section');
                if (workingHoursSection) {
                    if (this.value === 'minijob' || this.value === 'teilzeit') {
                        workingHoursSection.classList.remove('hidden');
                    } else {
                        workingHoursSection.classList.add('hidden');
                        // Clear all checkboxes when hiding
                        days.forEach(day => {
                            const checkbox = document.getElementById(`workday_${day}`);
                            if (checkbox) {
                                checkbox.checked = false;
                                const container = document.getElementById(`timeslots_${day}`);
                                if (container) {
                                    container.classList.add('hidden');
                                }
                            }
                        });
                    }
                }
            });
        }
    }

    function saveEmployee(event) {
        event.preventDefault();

        // Collect working hours data
        const workingHours = {};
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];

        days.forEach(day => {
            const checkbox = document.getElementById(`workday_${day}`);
            if (checkbox && checkbox.checked) {
                const container = document.getElementById(`timeslots_${day}`);
                const timeSlots = [];

                // Get all time slots for this day
                const slots = container.querySelectorAll('div.flex');
                slots.forEach(slot => {
                    const startInput = slot.querySelector('input[data-type="start"]');
                    const endInput = slot.querySelector('input[data-type="end"]');

                    if (startInput && endInput && startInput.value && endInput.value) {
                        timeSlots.push({
                            start: startInput.value,
                            end: endInput.value
                        });
                    }
                });

                if (timeSlots.length > 0) {
                    workingHours[day] = timeSlots;
                }
            }
        });

        const formData = {
            name: document.getElementById('emp_name').value,
            personalNr: document.getElementById('emp_personalNr').value,
            abteilung: document.getElementById('emp_abteilung').value,
            position: document.getElementById('emp_position').value,
            email: document.getElementById('emp_email').value,
            telefon: document.getElementById('emp_telefon').value || '',
            employmentType: document.getElementById('emp_employment_type').value,
            workingHours: workingHours,
            spezialisierungen: employeeTags,
            status: document.getElementById('emp_status').value
        };
        
        console.log('Neuer Mitarbeiter:', formData);
        
        // Save to LocalStorage
        saveEmployeeToStorage(formData);
        
        alert('Mitarbeiterprofil wurde erfolgreich angelegt!');
        
        // Reset form and tags
        document.getElementById('employeeForm').reset();
        employeeTags = [];
        renderTags();
        updateTagSuggestions();
        
        // Refresh employee list
        refreshEmployeeList();
    }

    function createEmployeeManagementView() {
        const mainContent = document.querySelector('main');
        const employeeHTML = `
            <div id="employee-management" class="w-full">
                <!-- Create Employee Section -->
                <div class="bg-white rounded-lg shadow-lg mb-8">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-lg">
                        <h2 class="text-xl font-bold flex items-center">
                            <svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                            </svg>
                            Neuen Mitarbeiter anlegen
                        </h2>
                    </div>
                    
                    <form id="employeeForm" onsubmit="saveEmployee(event)" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                                <input type="text" id="emp_name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Max Mustermann">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Personal-Nr. *</label>
                                <input type="text" id="emp_personalNr" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="LT-2025-001">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Zuteilungskategorie *</label>
                                <select id="emp_abteilung" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Wählen Sie eine Abteilung</option>
                                    <option value="textilien">Allgemein</option>
                                    <option value="accessoires">Accessoires</option>
                                    <option value="gebaeude">Gebäudeschäden</option>
                                    <option value="schuhe">Schuhe & Taschen</option>
                                    <option value="schuhe">Textilien</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">LvL *</label>
                                <select id="emp_position" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Wählen Sie eine Position</option>
                                    <option value="neuling">Neuling</option>
                                    <option value="normal">Normal</option>
                                    <option value="experte">Experte</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail *</label>
                                <input type="email" id="emp_email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="max.mustermann@gev.de">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                                <input type="tel" id="emp_telefon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="+49 123 456789">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Beschäftigungsart *</label>
                                <select id="emp_employment_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Wählen Sie eine Beschäftigungsart</option>
                                    <option value="minijob">Minijobber</option>
                                    <option value="teilzeit">Teilzeit</option>
                                    <option value="vollzeit">Vollzeit</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="emp_status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="aktiv">Aktiv</option>
                                    <option value="urlaub">Im Urlaub</option>
                                    <option value="krank">Krankheit</option>
                                    <option value="inaktiv">Inaktiv</option>
                                </select>
                            </div>
                            
                            <!-- Arbeitszeiten für Neufälle -->
                            <div class="col-span-3 hidden" id="working-hours-section">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Arbeitszeiten für Neufälle</label>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="space-y-4" id="workingHoursContainer">
                                        <!-- Monday -->
                                        <div class="border-l-4 border-blue-500 pl-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="workday_monday" class="mr-2 rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                                    <span class="font-medium">Montag</span>
                                                </label>
                                                <button type="button" onclick="addTimeSlot('monday')" class="text-sm text-blue-600 hover:text-blue-800">
                                                    + Zeitfenster hinzufügen
                                                </button>
                                            </div>
                                            <div id="timeslots_monday" class="space-y-2 hidden">
                                                <div class="flex gap-2 items-center">
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Von">
                                                    <span class="text-gray-500">-</span>
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Bis">
                                                    <button type="button" onclick="removeTimeSlot(this)" class="text-red-500 hover:text-red-700">
                                                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tuesday -->
                                        <div class="border-l-4 border-blue-500 pl-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="workday_tuesday" class="mr-2 rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                                    <span class="font-medium">Dienstag</span>
                                                </label>
                                                <button type="button" onclick="addTimeSlot('tuesday')" class="text-sm text-blue-600 hover:text-blue-800">
                                                    + Zeitfenster hinzufügen
                                                </button>
                                            </div>
                                            <div id="timeslots_tuesday" class="space-y-2 hidden">
                                                <div class="flex gap-2 items-center">
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Von">
                                                    <span class="text-gray-500">-</span>
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Bis">
                                                    <button type="button" onclick="removeTimeSlot(this)" class="text-red-500 hover:text-red-700">
                                                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Wednesday -->
                                        <div class="border-l-4 border-blue-500 pl-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="workday_wednesday" class="mr-2 rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                                    <span class="font-medium">Mittwoch</span>
                                                </label>
                                                <button type="button" onclick="addTimeSlot('wednesday')" class="text-sm text-blue-600 hover:text-blue-800">
                                                    + Zeitfenster hinzufügen
                                                </button>
                                            </div>
                                            <div id="timeslots_wednesday" class="space-y-2 hidden">
                                                <div class="flex gap-2 items-center">
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Von">
                                                    <span class="text-gray-500">-</span>
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Bis">
                                                    <button type="button" onclick="removeTimeSlot(this)" class="text-red-500 hover:text-red-700">
                                                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Thursday -->
                                        <div class="border-l-4 border-blue-500 pl-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="workday_thursday" class="mr-2 rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                                    <span class="font-medium">Donnerstag</span>
                                                </label>
                                                <button type="button" onclick="addTimeSlot('thursday')" class="text-sm text-blue-600 hover:text-blue-800">
                                                    + Zeitfenster hinzufügen
                                                </button>
                                            </div>
                                            <div id="timeslots_thursday" class="space-y-2 hidden">
                                                <div class="flex gap-2 items-center">
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Von">
                                                    <span class="text-gray-500">-</span>
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Bis">
                                                    <button type="button" onclick="removeTimeSlot(this)" class="text-red-500 hover:text-red-700">
                                                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Friday -->
                                        <div class="border-l-4 border-blue-500 pl-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="workday_friday" class="mr-2 rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                                    <span class="font-medium">Freitag</span>
                                                </label>
                                                <button type="button" onclick="addTimeSlot('friday')" class="text-sm text-blue-600 hover:text-blue-800">
                                                    + Zeitfenster hinzufügen
                                                </button>
                                            </div>
                                            <div id="timeslots_friday" class="space-y-2 hidden">
                                                <div class="flex gap-2 items-center">
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Von">
                                                    <span class="text-gray-500">-</span>
                                                    <input type="time" class="px-2 py-1 border border-gray-300 rounded" placeholder="Bis">
                                                    <button type="button" onclick="removeTimeSlot(this)" class="text-red-500 hover:text-red-700">
                                                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Spezialisierungen Tags -->
                            <div class="col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                                    <span>Spezialisierungen (optional)</span>
                                    <button type="button" id="edit-tags-btn" onclick="toggleTagsEdit()" class="text-blue-600 hover:text-blue-800 hidden">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                </label>
                                
                                <!-- Tags Display Container (Compact View) -->
                                <div id="tags-display" class="hidden">
                                    <div class="flex flex-wrap gap-1 p-2 bg-gray-50 border border-gray-200 rounded-lg" id="tags-display-list">
                                        <!-- Tags will be displayed here when not editing -->
                                    </div>
                                </div>
                                
                                <!-- Tags Edit Container -->
                                <div id="tags-edit" class="relative">
                                    <div id="tags-container" class="w-full min-h-[42px] px-3 py-2 border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent flex flex-wrap gap-2 items-center bg-white">
                                        <input type="text" id="tags-input" class="flex-1 min-w-[150px] outline-none border-none p-0" placeholder="" onkeydown="handleTagInput(event)">
                                    </div>
                                    <div class="mt-2 flex flex-wrap gap-2" id="tags-suggestions">
                                        <span class="text-xs text-gray-500">Tags:</span>
                                        <button type="button" onclick="addTag('Glas & Porzellan')" data-tag="Glas & Porzellan" class="tag-suggestion text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Glas & Porzellan</button>
                                        <button type="button" onclick="addTag('Empfindliche Textilien')" data-tag="Empfindliche Textilien" class="tag-suggestion text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Empfindliche Textilien</button>
                                        <button type="button" onclick="addTag('Lederwaren')" data-tag="Lederwaren" class="tag-suggestion text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Lederwaren</button>
                                        <button type="button" onclick="addTag('Parfüm & Kosmetik')" data-tag="Parfüm & Kosmetik" class="tag-suggestion text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Parfüm & Kosmetik</button>
                                        <button type="button" onclick="addTag('Zerbrechliche Deko-Artikel')" data-tag="Zerbrechliche Deko-Artikel" class="tag-suggestion text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Zerbrechliche Deko-Artikel</button>
                                        <button type="button" onclick="addTag('Schwere Artikel')" data-tag="Schwere Artikel" class="tag-suggestion text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Schwere Artikel</button>
                                        <button type="button" onclick="addTag('Kleinteilige Ware')" data-tag="Kleinteilige Ware" class="tag-suggestion text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Kleinteilige Ware</button>
                                        <button type="button" onclick="addTag('Schuhe')" data-tag="Schuhe" class="tag-suggestion text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Schuhe</button>
                                    </div>
                                    <div class="mt-2 flex justify-end">
                                        <button type="button" id="finish-tags-btn" onclick="finishTagsEdit()" class="text-xs px-3 py-1 text-green-600 hover:text-green-800 bg-green-100 hover:bg-green-200 rounded transition-colors">
                                            Fertig
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center">
                                <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                                </svg>
                                Mitarbeiter anlegen
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Employee List Section -->
                <div class="bg-white rounded-lg shadow-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center justify-between">
                            <span class="flex items-center">
                                <svg class="h-6 w-6 mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                </svg>
                                Mitarbeiterübersicht
                            </span>
                            <span class="text-sm text-gray-500" id="employee-count">8 Mitarbeiter</span>
                        </h2>
                    </div>
                    
                    <div class="p-6 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Abteilung</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Auslastung</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="employee-list" class="bg-white divide-y divide-gray-200">
                                <!-- Employee list will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Insert after canvas
        const canvas = document.getElementById('dashboardCanvas');
        canvas.insertAdjacentHTML('afterend', employeeHTML);
        
        // Hide the new element initially
        document.getElementById('employee-management').classList.add('hidden');
    }
    
    // Case Management Functions
    let caseSimulationInterval;
    let caseIdCounter = 98360;
    
    function createCaseManagementView() {
        const mainContent = document.querySelector('main');
        
        // Static lieferschein data - initially unassigned
        const staticCases = [
            { id: 'LS-2024-0862', time: '09:15', type: 'Textilien', items: 45, amount: 7785, employee: 'Frank Nagel', avatar: 'FN', status: 'Neu', priority: 'Normal', skills: ['Hängeware'] },
            { id: 'LS-2024-0863', time: '09:22', type: 'Schuhe & Taschen', items: 120, amount: 43522, employee: 'David Fuchs', avatar: 'DF', status: 'Neu', priority: 'Mittel' },
            { id: 'LS-2024-0864', time: '09:28', type: 'Accessoires', items: 85, amount: 41078, employee: 'Frank Nagel', avatar: 'FN', status: 'Neu', priority: 'Normal' },
            { id: 'LS-2024-0865', time: '09:35', type: 'Accessoires', items: 68, amount: 22858, employee: 'David Fuchs', avatar: 'DF', status: 'Neu', priority: 'Hoch' },
            { id: 'LS-2024-0866', time: '09:41', type: 'Textilien', items: 92, amount: 37421, employee: 'Bernd Maier', avatar: 'BM', status: 'Neu', priority: 'Hoch' },
            { id: 'LS-2024-0867', time: '09:48', type: 'Oberbekleidung', items: 35, amount: 1434, employee: 'David Fuchs', avatar: 'DF', status: 'Neu', priority: 'Normal' },
            { id: 'LS-2024-0868', time: '09:55', type: 'Accessoires', items: 78, amount: 37330, employee: 'Hans Richter', avatar: 'HR', status: 'Neu', priority: 'Normal' },
            { id: 'LS-2024-0869', time: '10:02', type: 'Textilien', items: 110, amount: 36088, employee: 'Hans Richter', avatar: 'HR', status: 'Neu', priority: 'Mittel' },
            { id: 'LS-2024-0870', time: '10:08', type: 'Oberbekleidung', items: 42, amount: 11004, employee: 'David Fuchs', avatar: 'DF', status: 'Neu', priority: 'Normal' },
            { id: 'LS-2024-0871', time: '10:15', type: 'Textilien', items: 156, amount: 39477, employee: 'Frank Nagel', avatar: 'FN', status: 'Neu', priority: 'Normal' },
            { id: 'LS-2024-0872', time: '10:22', type: 'Oberbekleidung', items: 48, amount: 14185, employee: 'Anna Schmidt', avatar: 'AS', status: 'Neu', priority: 'Mittel' },
            { id: 'LS-2024-0873', time: '10:28', type: 'Textilien', items: 38, amount: 9743, employee: 'Bernd Maier', avatar: 'BM', status: 'Neu', priority: 'Normal' },
            { id: 'LS-2024-0874', time: '10:35', type: 'Oberbekleidung', items: 28, amount: 7483, employee: 'Frank Nagel', avatar: 'FN', status: 'Neu', priority: 'Mittel' },
            { id: 'LS-2024-0875', time: '10:41', type: 'Schuhe & Taschen', items: 55, amount: 3174, employee: 'David Fuchs', avatar: 'DF', status: 'Neu', priority: 'Normal' },
            { id: 'LS-2024-0876', time: '10:48', type: 'Textilien', items: 87, amount: 29521, employee: 'Bernd Maier', avatar: 'BM', status: 'Neu', priority: 'Mittel' },
            { id: 'LS-2024-0877', time: '10:55', type: 'Textilien', items: 98, amount: 32741, employee: 'Bernd Maier', avatar: 'BM', status: 'Neu', priority: 'Hoch' },
            { id: 'LS-2024-0878', time: '11:02', type: 'Schuhe & Taschen', items: 32, amount: 1509, employee: 'David Fuchs', avatar: 'DF', status: 'Neu', priority: 'Normal' },
            { id: 'LS-2024-0879', time: '11:08', type: 'Accessoires', items: 105, amount: 37497, employee: 'Hans Richter', avatar: 'HR', status: 'Neu', priority: 'Normal' }
        ];
        
        // Check if auto-assignment is active
        const isAutoAssigned = localStorage.getItem('autoAssignmentActive') === 'true';
        
        const caseHTML = `
            <div id="case-management" class="w-full hidden">
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex items-center">
                            <div class="bg-blue-100 rounded-lg p-3 mr-3">
                                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Neue Lieferungen</p>
                                <p class="text-2xl font-bold text-gray-800">24</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex items-center">
                            <div class="bg-green-100 rounded-lg p-3 mr-3">
                                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Artikel heute</p>
                                <p class="text-2xl font-bold text-gray-800">1847</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 rounded-lg p-3 mr-3">
                                <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">In Bearbeitung</p>
                                <p class="text-2xl font-bold text-gray-800">45</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex items-center">
                            <div class="bg-purple-100 rounded-lg p-3 mr-3">
                                <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Verfügbare Auspacker</p>
                                <p class="text-2xl font-bold text-gray-800">6</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Two Column Layout -->
                <div class="flex gap-4">
                    <!-- Employee List (Left) -->
                    <div class="bg-white rounded-lg shadow flex-1">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-800">Paketauspacker</h2>
                            <p class="text-sm text-gray-600 mt-1">Aktuelle Auslastung und Verfügbarkeit</p>
                        </div>
                        
                        <div class="p-4 overflow-x-auto max-h-[600px] overflow-y-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mitarbeiter</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Abteilung</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Auslastung</th>
                                    </tr>
                                </thead>
                                <tbody id="case-employee-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Employees will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Cases Table (Right) -->
                    <div class="bg-white rounded-lg shadow flex-1">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-800">Lieferscheinzuteilung</h2>
                                <p class="text-sm text-gray-600 mt-1">Übersicht der zugewiesenen Lieferscheine</p>
                            </div>
                            <button id="auto-assign-btn" onclick="toggleAutoAssignment()" class="relative group p-3 ${isAutoAssigned ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-500 hover:bg-blue-600'} text-white rounded-lg transition-colors">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                <div class="absolute bottom-full right-0 mb-2 px-3 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                    ${isAutoAssigned ? 'Automatische Zuweisung deaktivieren' : 'Starte automatische Zuweisung'}
                                </div>
                            </button>
                        </div>
                        
                        <div class="p-4 overflow-x-auto max-h-[600px] overflow-y-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Lieferschein-ID</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Zeit</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Typ</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Artikel</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Zeit (Min)</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mitarbeiter</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="cases-table-body" class="bg-white divide-y divide-gray-200">
                                    ${staticCases.map(c => {
                                        const assigned = isAutoAssigned;
                                        return `
                                        <tr>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${c.id}</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">${c.time}</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-900">${c.type}</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-900">${c.items || Math.floor(c.amount/100)} Stück</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-900">${Math.floor((c.items || Math.floor(c.amount/100)) * 2.5)} Min</td>
                                            <td class="px-3 py-2 whitespace-nowrap">
                                                ${assigned ? `
                                                <div class="flex items-center">
                                                    <div class="h-6 w-6 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-bold mr-1">
                                                        ${c.avatar}
                                                    </div>
                                                    <span class="text-xs text-gray-900">${c.employee}</span>
                                                </div>
                                                ` : `
                                                <span class="text-xs text-gray-500 italic">Nicht zugewiesen</span>
                                                `}
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                    assigned ? 
                                                        (c.status === 'In Bearbeitung' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800') :
                                                        'bg-red-100 text-red-800'
                                                }">
                                                    ${assigned ? 'Zugewiesen' : 'Neu'}
                                                </span>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Mehrauftragszuweisung Label -->
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-500 italic">(Mehrauftragszuweisung -> Wenn mehrere Aufträge, dann nach Priorität gelistet. Wenn nur ein Auftrag, dann nach priorität zugeteilt)</p>
                </div
                
            </div>
        `;
        
        // Insert after canvas
        const canvas = document.getElementById('dashboardCanvas');
        canvas.insertAdjacentHTML('afterend', caseHTML);
    }
    
    function refreshCaseEmployeeList() {
        const employees = loadEmployeesFromStorage();
        const tbody = document.getElementById('case-employee-list');
        if (!tbody) return;
        
        const isAutoAssigned = localStorage.getItem('autoAssignmentActive') === 'true';
        
        // Create employee case mapping
        const employeeCases = {
            'Frank Nagel': ['SF-98362', 'SF-98364', 'SF-98371', 'SF-98374'],
            'David Fuchs': ['SF-98363', 'SF-98365', 'SF-98367', 'SF-98370', 'SF-98375', 'SF-98378'],
            'Bernd Maier': ['SF-98366', 'SF-98373', 'SF-98376', 'SF-98377'],
            'Hans Richter': ['SF-98368', 'SF-98369', 'SF-98379'],
            'Anna Schmidt': ['SF-98372'],
            'Carla Huber': [],
            'Eva Klein': [],
            'Gabi Lorenz': []
        };
        
        tbody.innerHTML = employees.map((emp, index) => {
            const cases = isAutoAssigned ? (employeeCases[emp.name] || []) : [];
            const workloadPercent = (emp.workload / emp.maxWorkload) * 100;
            const statusColor = workloadPercent >= 90 ? 'yellow' : 'blue';
            return `
            <tr class="drop-zone"
                data-employee-name="${emp.name}"
                ondrop="handleCaseDrop(event, '${emp.name}')"
                ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)"
                ondragenter="handleDragEnter(event)">
                <td class="px-4 py-2 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="h-8 w-8 flex-shrink-0 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold">${emp.avatar}</div>
                        <div class="ml-2">
                            <div class="text-sm font-medium text-gray-900 employee-name">${emp.name}</div>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${emp.abteilung || 'Allgemein'}</td>
                <td class="px-4 py-2 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        workloadPercent < 90 ? 'bg-green-100 text-green-800' :
                        workloadPercent >= 90 ? 'bg-yellow-100 text-yellow-800' :
                        'bg-gray-100 text-gray-800'
                    }">${workloadPercent >= 90 ? 'Beschäftigt' : 'Verfügbar'}</span>
                </td>
                <td class="px-4 py-2 whitespace-nowrap">
                    <div class="flex items-center ${isAutoAssigned ? 'cursor-pointer hover:opacity-80' : ''}" ${isAutoAssigned ? `onclick="showEmployeeCasesModal('${emp.name}')"` : ''}>
                        <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2 max-w-[100px]">
                            <div class="bg-${statusColor}-500 h-2 rounded-full employee-workload-bar" style="width: ${workloadPercent}%"></div>
                        </div>
                        <span class="text-xs text-gray-600 employee-workload-text">${emp.workload}/${emp.maxWorkload} Min</span>
                    </div>
                </td>
            </tr>
        `}).join('');
    }
    
    // Static lieferschein details for reference
    const caseDetails = {
        'LS-2024-0862': { type: 'Textilien', amount: 7785, items: 45, priority: 'Normal' },
        'LS-2024-0863': { type: 'Schuhe & Taschen', amount: 43522, items: 120, priority: 'Mittel' },
        'LS-2024-0864': { type: 'Accessoires', amount: 41078, items: 85, priority: 'Normal' },
        'LS-2024-0865': { type: 'Accessoires', amount: 22858, items: 68, priority: 'Hoch' },
        'LS-2024-0866': { type: 'Textilien', amount: 37421, items: 92, priority: 'Hoch' },
        'LS-2024-0867': { type: 'Oberbekleidung', amount: 1434, items: 35, priority: 'Normal' },
        'LS-2024-0868': { type: 'Accessoires', amount: 37330, items: 78, priority: 'Normal' },
        'LS-2024-0869': { type: 'Textilien', amount: 36088, items: 110, priority: 'Mittel' },
        'LS-2024-0870': { type: 'Oberbekleidung', amount: 11004, items: 42, priority: 'Normal' },
        'LS-2024-0871': { type: 'Textilien', amount: 39477, items: 156, priority: 'Normal' },
        'LS-2024-0872': { type: 'Oberbekleidung', amount: 14185, items: 48, priority: 'Mittel' },
        'LS-2024-0873': { type: 'Textilien', amount: 9743, items: 38, priority: 'Normal' },
        'LS-2024-0874': { type: 'Oberbekleidung', amount: 7483, items: 28, priority: 'Mittel' },
        'LS-2024-0875': { type: 'Schuhe & Taschen', amount: 3174, items: 55, priority: 'Normal' },
        'LS-2024-0876': { type: 'Textilien', amount: 29521, items: 87, priority: 'Mittel' },
        'LS-2024-0877': { type: 'Textilien', amount: 32741, items: 98, priority: 'Hoch' },
        'LS-2024-0878': { type: 'Schuhe & Taschen', amount: 1509, items: 32, priority: 'Normal' },
        'LS-2024-0879': { type: 'Accessoires', amount: 37497, items: 105, priority: 'Normal' }
    };
    
    function showEmployeeCasesModal(employeeName) {
        // Get current case assignments from the table (reflects drag and drop changes)
        const employeeCases = [];
        const caseRows = document.querySelectorAll('#cases-table-body tr');
        
        // Collect cases assigned to this employee from the current table state
        caseRows.forEach(row => {
            const caseId = row.getAttribute('data-case-id');
            const employeeNameElement = row.querySelector('.case-employee-name');
            const currentEmployee = employeeNameElement ? employeeNameElement.textContent : '';
            
            if (currentEmployee === employeeName && caseDetails[caseId]) {
                employeeCases.push({
                    id: caseId,
                    type: caseDetails[caseId].type,
                    amount: caseDetails[caseId].amount,
                    status: 'Zugewiesen',
                    priority: caseDetails[caseId].priority
                });
            }
        });
        
        const cases = employeeCases;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('cases-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Create modal HTML
        const modalHTML = `
            <div id="cases-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[80vh] overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-lg flex items-center justify-between">
                        <h2 class="text-xl font-bold flex items-center">
                            <svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            Aktuelle Fälle - ${employeeName}
                        </h2>
                        <button onclick="closeEmployeeCasesModal()" class="text-white hover:text-gray-200">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto" style="max-height: calc(80vh - 100px)">
                        ${cases.length > 0 ? `
                            <div class="mb-4">
                                <p class="text-gray-600">Anzahl der Fälle: <span class="font-semibold">${cases.length}</span></p>
                            </div>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lieferschein-ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Typ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Artikel</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zeit (Min)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Priorität</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${cases.map((c, index) => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                                                Fall ${index + 1}: ${c.id}
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${c.type}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${c.items || Math.floor(c.amount/100)} Stück</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${Math.floor((c.items || Math.floor(c.amount/100)) * 2.5)} Min</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                    c.status === 'In Bearbeitung' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'
                                                }">
                                                    ${c.status}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                    c.priority === 'Hoch' ? 'bg-red-100 text-red-800' :
                                                    c.priority === 'Mittel' ? 'bg-yellow-100 text-yellow-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }">
                                                    ${c.priority}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <div class="text-center py-8">
                                <svg class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                                </svg>
                                <p class="text-gray-500">Keine Fälle zugewiesen</p>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    function closeEmployeeCasesModal() {
        const modal = document.getElementById('cases-modal');
        if (modal) {
            modal.remove();
        }
    }
    
    function toggleAutoAssignment() {
        const currentState = localStorage.getItem('autoAssignmentActive') === 'true';
        const newState = !currentState;
        localStorage.setItem('autoAssignmentActive', newState);

        if (!newState) {
            localStorage.removeItem('caseAssignments');
            // Reset workloads when deactivating
            const employees = loadEmployeesFromStorage();
            employees.forEach(emp => {
                emp.workload = 0;
            });
            localStorage.setItem('employees', JSON.stringify(employees));
        } else {
            // Perform automatic assignment based on minutes
            performMinuteBasedAssignment();
        }

        // Refresh the cases table
        updateCasesTable(newState);

        // Refresh employee list
        refreshCaseEmployeeList();

        // Update button appearance
        const button = document.getElementById('auto-assign-btn');
        if (button) {
            const tooltip = button.querySelector('.whitespace-nowrap');
            if (newState) {
                button.className = 'relative group p-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors';
                if (tooltip) tooltip.textContent = 'Automatische Zuweisung deaktivieren';

                // Show success animation
                showAssignmentAnimation();
            } else {
                button.className = 'relative group p-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors';
                if (tooltip) tooltip.textContent = 'Starte automatische Zuweisung';
            }
        }
    }

    function performMinuteBasedAssignment() {
        const employees = loadEmployeesFromStorage();
        const staticCases = [
            { id: 'LS-2024-0862', time: '09:15', type: 'Textilien', items: 45, employee: null },
            { id: 'LS-2024-0863', time: '09:22', type: 'Schuhe & Taschen', items: 120, employee: null },
            { id: 'LS-2024-0864', time: '09:28', type: 'Accessoires', items: 85, employee: null },
            { id: 'LS-2024-0865', time: '09:35', type: 'Accessoires', items: 68, employee: null },
            { id: 'LS-2024-0866', time: '09:41', type: 'Textilien', items: 92, employee: null },
            { id: 'LS-2024-0867', time: '09:48', type: 'Oberbekleidung', items: 35, employee: null },
            { id: 'LS-2024-0868', time: '09:55', type: 'Accessoires', items: 78, employee: null },
            { id: 'LS-2024-0869', time: '10:02', type: 'Textilien', items: 110, employee: null },
            { id: 'LS-2024-0870', time: '10:08', type: 'Oberbekleidung', items: 42, employee: null },
            { id: 'LS-2024-0871', time: '10:15', type: 'Textilien', items: 156, employee: null },
            { id: 'LS-2024-0872', time: '10:22', type: 'Oberbekleidung', items: 48, employee: null },
            { id: 'LS-2024-0873', time: '10:28', type: 'Textilien', items: 38, employee: null },
            { id: 'LS-2024-0874', time: '10:35', type: 'Oberbekleidung', items: 28, employee: null },
            { id: 'LS-2024-0875', time: '10:41', type: 'Schuhe & Taschen', items: 55, employee: null },
            { id: 'LS-2024-0876', time: '10:48', type: 'Textilien', items: 87, employee: null },
            { id: 'LS-2024-0877', time: '10:55', type: 'Textilien', items: 98, employee: null },
            { id: 'LS-2024-0878', time: '11:02', type: 'Schuhe & Taschen', items: 32, employee: null },
            { id: 'LS-2024-0879', time: '11:08', type: 'Accessoires', items: 105, employee: null }
        ];

        const assignments = {};

        // Sort cases by priority (more items = higher priority)
        staticCases.sort((a, b) => b.items - a.items);

        // Assign cases to employees based on available time
        staticCases.forEach(lieferschein => {
            const requiredTime = Math.floor(lieferschein.items * 2.5); // 2.5 minutes per item

            // Find best available employee
            const availableEmployee = employees
                .filter(emp => {
                    const hasSkill = checkEmployeeSkillMatch(emp, lieferschein.type);
                    const hasCapacity = (emp.workload + requiredTime) <= emp.maxWorkload;
                    return hasSkill && hasCapacity;
                })
                .sort((a, b) => a.workload - b.workload)[0]; // Choose employee with lowest current workload

            if (availableEmployee) {
                assignments[lieferschein.id] = availableEmployee.name;
                availableEmployee.workload += requiredTime;
            }
        });

        // Save assignments and updated workloads
        localStorage.setItem('caseAssignments', JSON.stringify(assignments));
        localStorage.setItem('employees', JSON.stringify(employees));
    }

    function checkEmployeeSkillMatch(employee, caseType) {
        const skillMap = {
            'Textilien': ['Empfindliche Textilien', 'Lederwaren'],
            'Schuhe & Taschen': ['Schuhe', 'Lederwaren', 'Schwere Artikel'],
            'Accessoires': ['Glas & Porzellan', 'Parfüm & Kosmetik', 'Zerbrechliche Deko-Artikel', 'Kleinteilige Ware'],
            'Oberbekleidung': ['Lederwaren', 'Empfindliche Textilien']
        };

        const requiredSkills = skillMap[caseType] || [];
        if (requiredSkills.length === 0) return true;

        return employee.skills && employee.skills.some(skill => requiredSkills.includes(skill));
    }
    
    function updateCasesTable(isAssigned) {
        const tbody = document.getElementById('cases-table-body');
        if (!tbody) return;
        
        const staticCases = [
            { id: 'LS-2024-0862', time: '09:15', type: 'Textilien', amount: 7785, items: 45, employee: 'Frank Nagel', avatar: 'FN' },
            { id: 'LS-2024-0863', time: '09:22', type: 'Schuhe & Taschen', amount: 43522, items: 120, employee: 'David Fuchs', avatar: 'DF' },
            { id: 'LS-2024-0864', time: '09:28', type: 'Accessoires', amount: 41078, items: 85, employee: 'Frank Nagel', avatar: 'FN' },
            { id: 'LS-2024-0865', time: '09:35', type: 'Accessoires', amount: 22858, items: 68, employee: 'David Fuchs', avatar: 'DF' },
            { id: 'LS-2024-0866', time: '09:41', type: 'Textilien', amount: 37421, items: 92, employee: 'Bernd Maier', avatar: 'BM' },
            { id: 'LS-2024-0867', time: '09:48', type: 'Oberbekleidung', amount: 1434, items: 35, employee: 'David Fuchs', avatar: 'DF' },
            { id: 'LS-2024-0868', time: '09:55', type: 'Accessoires', amount: 37330, items: 78, employee: 'Hans Richter', avatar: 'HR' },
            { id: 'LS-2024-0869', time: '10:02', type: 'Textilien', amount: 36088, items: 110, employee: 'Hans Richter', avatar: 'HR' },
            { id: 'LS-2024-0870', time: '10:08', type: 'Oberbekleidung', amount: 11004, items: 42, employee: 'David Fuchs', avatar: 'DF' },
            { id: 'LS-2024-0871', time: '10:15', type: 'Textilien', amount: 39477, items: 156, employee: 'Frank Nagel', avatar: 'FN' },
            { id: 'LS-2024-0872', time: '10:22', type: 'Oberbekleidung', amount: 14185, items: 48, employee: 'Anna Schmidt', avatar: 'AS' },
            { id: 'LS-2024-0873', time: '10:28', type: 'Textilien', amount: 9743, items: 38, employee: 'Bernd Maier', avatar: 'BM' },
            { id: 'LS-2024-0874', time: '10:35', type: 'Oberbekleidung', amount: 7483, items: 28, employee: 'Frank Nagel', avatar: 'FN' },
            { id: 'LS-2024-0875', time: '10:41', type: 'Schuhe & Taschen', amount: 3174, items: 55, employee: 'David Fuchs', avatar: 'DF' },
            { id: 'LS-2024-0876', time: '10:48', type: 'Textilien', amount: 29521, items: 87, employee: 'Bernd Maier', avatar: 'BM' },
            { id: 'LS-2024-0877', time: '10:55', type: 'Textilien', amount: 32741, items: 98, employee: 'Bernd Maier', avatar: 'BM' },
            { id: 'LS-2024-0878', time: '11:02', type: 'Schuhe & Taschen', amount: 1509, items: 32, employee: 'David Fuchs', avatar: 'DF' },
            { id: 'LS-2024-0879', time: '11:08', type: 'Accessoires', amount: 37497, items: 105, employee: 'Hans Richter', avatar: 'HR' }
        ];
        
        // Load saved assignments from localStorage
        const savedAssignments = loadAssignmentState();
        
        tbody.innerHTML = staticCases.map((c, index) => {
            // Check if there's a saved assignment for this case
            const assignedEmployee = savedAssignments[c.id];
            const hasAssignment = isAssigned || assignedEmployee;
            const displayEmployee = assignedEmployee || (isAssigned ? c.employee : null);
            const displayAvatar = assignedEmployee ? 
                displayEmployee.substring(0, 2).toUpperCase() : 
                (isAssigned ? c.avatar : null);
            
            return `
            <tr class="${hasAssignment ? 'assignment-animation' : ''}" 
                data-case-id="${c.id}"
                data-case-type="${c.type}"
                data-case-amount="${c.amount}"
                data-case-employee="${displayEmployee || ''}">
                <td class="px-3 py-2 whitespace-nowrap">
                    <span class="draggable-handle text-sm font-medium"
                          draggable="true"
                          ondragstart="handleCaseDragStart(event, '${c.id}', '${c.type}', ${c.amount}, '${c.employee}')"
                          ondragend="handleCaseDragEnd(event)">
                        ${c.id}
                    </span>
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">${c.time}</td>
                <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-900">${c.type}</td>
                <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-900">${c.items} Stück</td>
                <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-900">${Math.floor(c.items * 2.5)} Min</td>
                <td class="px-3 py-2 whitespace-nowrap">
                    ${hasAssignment ? `
                    <div class="flex items-center">
                        <div class="h-6 w-6 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-bold mr-1">
                            ${displayAvatar}
                        </div>
                        <span class="text-xs text-gray-900 case-employee-name">${displayEmployee}</span>
                    </div>
                    ` : `
                    <span class="text-xs text-gray-500 italic case-employee-name">Nicht zugewiesen</span>
                    `}
                </td>
                <td class="px-3 py-2 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full case-status-badge ${
                        hasAssignment ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">
                        ${hasAssignment ? 'Zugewiesen' : 'Neu'}
                    </span>
                </td>
            </tr>
        `}).join('');
        
        // Enable drag and drop after table update
        setTimeout(() => {
            enableDragAndDrop();
            // Update workload counts after loading saved assignments
            updateWorkloadCounts();
        }, 100);
    }
    
    function showAssignmentAnimation() {
        // Add animation class for visual feedback
        const rows = document.querySelectorAll('.assignment-animation');
        rows.forEach((row, index) => {
            setTimeout(() => {
                row.style.animation = 'fadeInScale 0.5s ease-out';
            }, index * 50);
        });
    }
    
    // Drag and Drop Functions
    let draggedCase = null;
    
    // Save case assignments to localStorage
    function saveAssignmentState() {
        const assignments = {};
        const caseRows = document.querySelectorAll('#cases-table-body tr');
        caseRows.forEach(row => {
            const caseId = row.getAttribute('data-case-id');
            const employeeNameElement = row.querySelector('.case-employee-name');
            const employee = employeeNameElement ? employeeNameElement.textContent : null;
            
            if (caseId && employee && employee !== 'Nicht zugewiesen') {
                assignments[caseId] = employee;
            }
        });
        localStorage.setItem('caseAssignments', JSON.stringify(assignments));
    }
    
    // Load case assignments from localStorage
    function loadAssignmentState() {
        const savedAssignments = localStorage.getItem('caseAssignments');
        if (savedAssignments) {
            return JSON.parse(savedAssignments);
        }
        return {};
    }
    
    function handleCaseDragStart(event, caseId, caseType, caseAmount, currentEmployee) {
        // Get the actual current employee from the row if assigned
        const parentRow = event.target.closest('tr');
        const employeeName = parentRow?.querySelector('.case-employee-name')?.textContent;
        
        draggedCase = {
            id: caseId,
            type: caseType,
            amount: caseAmount,
            currentEmployee: employeeName && employeeName !== 'Nicht zugewiesen' ? employeeName : null
        };
        
        event.target.classList.add('dragging');
        // Make the parent row semi-transparent
        if (parentRow) {
            parentRow.style.opacity = '0.5';
        }
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/html', event.target.innerHTML);
    }
    
    function handleCaseDragEnd(event) {
        event.target.classList.remove('dragging');
        // Reset the parent row opacity
        const parentRow = event.target.closest('tr');
        if (parentRow) {
            parentRow.style.opacity = '1';
        }
        draggedCase = null;
    }
    
    function handleDragOver(event) {
        if (event.preventDefault) {
            event.preventDefault();
        }
        event.dataTransfer.dropEffect = 'move';
        return false;
    }
    
    function handleDragEnter(event) {
        event.preventDefault();
        const row = event.target.closest('tr.drop-zone');
        if (row) {
            row.classList.add('drag-over');
        }
    }
    
    function handleDragLeave(event) {
        // Only remove drag-over if we're actually leaving the row
        const row = event.target.closest('tr.drop-zone');
        const relatedTarget = event.relatedTarget;
        
        if (row && relatedTarget) {
            // Check if the related target is still within the same row
            if (!row.contains(relatedTarget)) {
                row.classList.remove('drag-over');
            }
        }
    }
    
    function handleCaseDrop(event, newEmployee) {
        if (event.stopPropagation) {
            event.stopPropagation();
        }
        event.preventDefault();
        
        const row = event.target.closest('tr.drop-zone');
        if (row) {
            row.classList.remove('drag-over');
        }
        
        if (!draggedCase) return false;
        
        // Don't do anything if dropping on the same employee
        if (draggedCase.currentEmployee === newEmployee) {
            return false;
        }
        
        // Update the case in the cases table
        const caseRow = document.querySelector(`tr[data-case-id="${draggedCase.id}"]`);
        if (caseRow) {
            const employeeCell = caseRow.querySelector('td:nth-child(5)'); // Employee column
            const statusBadge = caseRow.querySelector('.case-status-badge');
            
            if (employeeCell) {
                const employees = loadEmployeesFromStorage();
                const employee = employees.find(e => e.name === newEmployee);
                const avatar = employee ? employee.avatar : newEmployee.substring(0, 2).toUpperCase();
                
                employeeCell.innerHTML = `
                    <div class="flex items-center">
                        <div class="h-6 w-6 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-bold mr-1">
                            ${avatar}
                        </div>
                        <span class="text-xs text-gray-900 case-employee-name">${newEmployee}</span>
                    </div>
                `;
            }
            
            // Update status badge to show assigned
            if (statusBadge) {
                statusBadge.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full case-status-badge bg-green-100 text-green-800';
                statusBadge.textContent = 'Zugewiesen';
            }
            
            // Save the new assignment state to localStorage
            saveAssignmentState();
            
            // Update workload counts immediately after assignment
            updateWorkloadCounts();
            
            // Update data attributes
            caseRow.setAttribute('data-case-employee', newEmployee);
            
            // Visual feedback with animation
            caseRow.style.animation = '';
            setTimeout(() => {
                caseRow.style.animation = 'fadeInScale 0.3s ease-out';
            }, 10);
            
            // Update workload counts for both old and new employee
            updateWorkloadCounts();
            
            // If auto-assignment is off, we should still enable it visually
            const isAutoAssigned = localStorage.getItem('autoAssignmentActive') === 'true';
            if (!isAutoAssigned) {
                // Mark that we have manual assignments
                localStorage.setItem('hasManualAssignments', 'true');
            }
            
            // Save state to localStorage
            saveAssignmentState();
        }
        
        return false;
    }
    
    function updateWorkloadCounts() {
        // Get all cases from the table
        const caseRows = document.querySelectorAll('#cases-table-body tr');
        const employeeCaseCounts = {};
        
        // Count cases per employee
        caseRows.forEach(row => {
            const employeeName = row.querySelector('.case-employee-name')?.textContent;
            if (employeeName && employeeName !== 'Nicht zugewiesen') {
                employeeCaseCounts[employeeName] = (employeeCaseCounts[employeeName] || 0) + 1;
            }
        });
        
        // Update employee workload displays
        const employeeRows = document.querySelectorAll('#case-employee-list tr');
        employeeRows.forEach(row => {
            const employeeName = row.querySelector('.employee-name')?.textContent;
            if (employeeName) {
                const count = employeeCaseCounts[employeeName] || 0;
                const workloadBar = row.querySelector('.employee-workload-bar');
                const workloadText = row.querySelector('.employee-workload-text');
                
                if (workloadBar) {
                    workloadBar.style.width = `${(count/8)*100}%`;
                    workloadBar.className = count > 0 ? 
                        'bg-blue-500 h-2 rounded-full employee-workload-bar' : 
                        'bg-gray-500 h-2 rounded-full employee-workload-bar';
                }
                if (workloadText) {
                    workloadText.textContent = `${count}/8`;
                }
            }
        });
    }
    
    function loadAssignmentState() {
        // Load saved assignments from localStorage
        const savedAssignments = localStorage.getItem('caseAssignments');
        if (savedAssignments) {
            return JSON.parse(savedAssignments);
        }
        return {};
    }
    
    function enableDragAndDrop() {
        // This function is called after table updates to ensure drag and drop is working
        const draggableHandles = document.querySelectorAll('.draggable-handle');
        draggableHandles.forEach(handle => {
            // Remove any existing listeners to prevent duplicates
            const newHandle = handle.cloneNode(true);
            handle.parentNode.replaceChild(newHandle, handle);
            
            newHandle.addEventListener('dragstart', (e) => {
                e.target.classList.add('dragging');
            });
            newHandle.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
            });
        });
    }
    
    function createTechnicalSketchView() {
        const sketchHTML = `
            <div id="technical-sketch" class="w-full hidden">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Technische Erst-Skizze</h2>
                    
                    <!-- Phase 1: Eingang -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">1. Neufall-Eingang</h3>
                        <div class="bg-gray-50 p-4 rounded font-mono text-sm">
                            <p class="mb-2">SAP → (optional) LLM liest Neufälle via OData-Protokoll ODER Haupt-Klassifizierung in SAP per BR-Framework+ (Kategorie (z. B. 0IS_COMPLEX) in SAP schreiben)</p>
                            <p class="ml-8 text-gray-600">↓</p>
                            <p>(einfach/mittel/komplex/sehr komplex) → Fall landet in Alle Neufälle</p>
                        </div>
                    </div>
                    
                    <!-- Phase 2: Verteilung -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">2. Fall-Verteilung</h3>
                        <div class="bg-gray-50 p-4 rounded font-mono text-sm">
                            <p class="mb-2">Alle Neufälle → Algorithmus holt Zahlen aus Workload Management for Claims</p>
                            <p class="ml-8 text-gray-600">(Fälle gesamt, Bearbeiter gesamt, heute verfügbar, aktuelle Last)</p>
                            <p class="ml-8 text-gray-600 mb-2">↓</p>
                            <p class="mb-2">Regeln prüfen mit RBP/BRF+ (wer passt) / Kategorisierung LLM oder beides</p>
                            <p class="ml-8 text-gray-600 mb-2">↓</p>
                            <p>Fair verteilen über SAP → Bearbeiter sieht Fall in SAP/My Inbox oder im eigenen Dashboard</p>
                        </div>
                    </div>
                    
                    <!-- Phase 3: Abschluss -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">3. Fall-Abschluss</h3>
                        <div class="bg-gray-50 p-4 rounded font-mono text-sm">
                            <p class="mb-2">Bearbeiter fertig → Task in Outbox abgeschlossen oder Claim-Status „Closed" oder eigenes Dashboard</p>
                            <p class="ml-8 text-gray-600 mb-2">↓</p>
                            <p class="mb-2">Info abholen oder per Event „Inform of Insurance Claim Closed" bekommen</p>
                            <p class="ml-8 text-gray-600 mb-2">↓</p>
                            <p>Bearbeiter kann neue Fälle aufnehmen</p>
                        </div>
                    </div>
                    
                    <!-- Alternative Option -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Alternative: Vorverteilung</h3>
                        <div class="bg-gray-50 p-4 rounded font-mono text-sm">
                            <p class="mb-2">(oder Vorverteilung von fester Maximalanzahl für gesamten Tag/Woche)</p>
                            <p class="ml-8 text-gray-600">→ Tag empfohlen für Krankheitshandling</p>
                            <p class="ml-8 text-gray-600">→ ansonsten mit Umplanungshandling</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Insert after canvas
        const canvas = document.getElementById('dashboardCanvas');
        canvas.insertAdjacentHTML('afterend', sketchHTML);
    }
    
    function showTechnicalSketch() {
        // Hide all views
        document.getElementById('dashboardCanvas').style.display = 'none';

        const employeeView = document.getElementById('employee-management');
        if (employeeView) {
            employeeView.classList.add('hidden');
        }

        const caseView = document.getElementById('case-management');
        if (caseView) {
            caseView.classList.add('hidden');
        }

        // Hide analytics dashboard
        const analyticsView = document.getElementById('analytics-dashboard');
        if (analyticsView) {
            analyticsView.classList.add('hidden');
        }
        
        // Show technical sketch view
        let sketchView = document.getElementById('technical-sketch');
        if (!sketchView) {
            createTechnicalSketchView();
            sketchView = document.getElementById('technical-sketch');
        }
        sketchView.classList.remove('hidden');
        
        // Update page title
        const pageTitle = document.querySelector('h1');
        if (pageTitle) {
            pageTitle.textContent = 'Technische Skizze';
        }
        
        // Update sidebar navigation
        updateSidebarNavigation('nav-sketch');
    }
    
    function startCaseSimulation() {
        // Clear previous interval if exists
        if (caseSimulationInterval) {
            clearInterval(caseSimulationInterval);
        }
        
        // Update statistics
        updateCaseStatistics();
        
        // Simulate new cases every 3-7 seconds
        caseSimulationInterval = setInterval(() => {
            generateNewCase();
        }, Math.random() * 4000 + 3000);
    }
    
    function generateNewCase() {
        const caseTypes = ['Textilien', 'Schuhe & Taschen', 'Accessoires', 'Oberbekleidung', 'Sonderlieferungen'];
        const employees = loadEmployeesFromStorage().filter(e => e.status === 'aktiv' || e.status === 'Verfügbar');
        
        const newCase = {
            id: `SF-${caseIdCounter++}`,
            time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
            type: caseTypes[Math.floor(Math.random() * caseTypes.length)],
            amount: Math.floor(Math.random() * 50000) + 1000,
            employee: employees[Math.floor(Math.random() * employees.length)],
            priority: Math.random() > 0.8 ? 'Hoch' : Math.random() > 0.5 ? 'Mittel' : 'Normal'
        };
        
        // Add case to table
        const tbody = document.getElementById('cases-list');
        if (tbody) {
            const row = document.createElement('tr');
            row.className = 'fade-in';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${newCase.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${newCase.time}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${newCase.type}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${newCase.amount.toLocaleString('de-DE')} €</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-bold mr-2">
                            ${newCase.employee ? newCase.employee.avatar || newCase.employee.name.substring(0, 2).toUpperCase() : 'NA'}
                        </div>
                        <span class="text-sm text-gray-900">${newCase.employee ? newCase.employee.name : 'Nicht zugewiesen'}</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                        Zugewiesen
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        newCase.priority === 'Hoch' ? 'bg-red-100 text-red-800' :
                        newCase.priority === 'Mittel' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-gray-100 text-gray-800'
                    }">
                        ${newCase.priority}
                    </span>
                </td>
            `;
            tbody.insertBefore(row, tbody.firstChild);
            
            // Keep only last 20 cases
            while (tbody.children.length > 20) {
                tbody.removeChild(tbody.lastChild);
            }
            
            // Update counters
            updateCaseStatistics();
        }
    }
    
    function updateCaseStatistics() {
        const employees = loadEmployeesFromStorage();
        const availableCount = employees.filter(e => e.status === 'aktiv' || e.status === 'Verfügbar').length;
        
        document.getElementById('available-employees').textContent = availableCount;
        
        // Update other counters
        const newCasesEl = document.getElementById('new-cases-count');
        if (newCasesEl) {
            newCasesEl.textContent = parseInt(newCasesEl.textContent) + 1;
        }
        
        const autoAssignedEl = document.getElementById('auto-assigned-count');
        if (autoAssignedEl) {
            autoAssignedEl.textContent = parseInt(autoAssignedEl.textContent) + 1;
        }
        
        const inProgressEl = document.getElementById('in-progress-count');
        if (inProgressEl) {
            const cases = document.querySelectorAll('#cases-list tr').length;
            inProgressEl.textContent = cases;
        }
    }

    // Create Analytics Dashboard
    function createAnalyticsDashboard() {
        const mainContent = document.querySelector('main');
        const analyticsHTML = `
            <div id="analytics-dashboard" class="w-full">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-gray-600 text-sm font-medium">Neue Lieferscheine (Heute)</h3>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Live</span>
                        </div>
                        <p class="text-3xl font-bold text-gray-900">18</p>
                        <p class="text-sm text-gray-500 mt-2">+12% vs. Gestern</p>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-gray-600 text-sm font-medium">Automatisch zugewiesen</h3>
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">95%</span>
                        </div>
                        <p class="text-3xl font-bold text-gray-900">17</p>
                        <p class="text-sm text-gray-500 mt-2">1 manuell zugewiesen</p>
                    </div>
                </div>

                <!-- Employee Performance by Position -->
                <div class="bg-white rounded-lg shadow-lg mb-8">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800">Mitarbeiter-Performance nach Position</h2>
                        <p class="text-sm text-gray-600 mt-1">Durchschnittliche Bearbeitungszeiten und Fälle</p>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="position-stats">
                            <!-- Position stats will be dynamically loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Chart and Employee List - Reorganized Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Employee Analytics List (Now on the left) -->
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex flex-col gap-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 class="text-xl font-semibold text-gray-800">Mitarbeiter-Statistiken</h2>
                                        <p class="text-sm text-gray-600 mt-1">Klicken Sie für detaillierte Analysen</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="filterEmployeesByType('all')" id="filter-all" class="employment-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Alle</button>
                                        <button onclick="filterEmployeesByType('vollzeit')" id="filter-vollzeit" class="employment-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Vollzeit</button>
                                        <button onclick="filterEmployeesByType('teilzeit')" id="filter-teilzeit" class="employment-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Teilzeit</button>
                                        <button onclick="filterEmployeesByType('minijob')" id="filter-minijob" class="employment-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Minijob</button>
                                    </div>
                                </div>
                                <div class="flex gap-2 border-t pt-2">
                                    <span class="text-xs text-gray-500 self-center">Position:</span>
                                    <button onclick="filterEmployeesByPosition('all')" id="position-filter-all" class="position-main-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Alle</button>
                                    <button onclick="filterEmployeesByPosition('junior')" id="position-filter-junior" class="position-main-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Junior</button>
                                    <button onclick="filterEmployeesByPosition('lagerarbeiter')" id="position-filter-lagerarbeiter" class="position-main-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Lagerarbeiter</button>
                                    <button onclick="filterEmployeesByPosition('senior')" id="position-filter-senior" class="position-main-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Senior</button>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 overflow-y-auto" style="max-height: 400px;">
                            <div id="employee-analytics-list" class="space-y-3">
                                <!-- Employee analytics will be loaded here -->
                            </div>
                        </div>
                        <div class="border-t border-gray-200 p-4">
                            <button onclick="openComparisonModal()" class="w-full px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-medium rounded-lg hover:from-indigo-600 hover:to-purple-700 transition-all duration-200 flex items-center justify-center">
                                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                                Analytics im Vergleich
                            </button>
                        </div>
                    </div>

                    <!-- Cases Chart (Now on the right) -->
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h2 class="text-xl font-semibold text-gray-800">Lieferscheinbearbeitung im Zeitverlauf</h2>
                                <div class="flex gap-2">
                                    <button onclick="changeChartFilter('day')" class="chart-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Tag</button>
                                    <button onclick="changeChartFilter('week')" class="chart-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Woche</button>
                                    <button onclick="changeChartFilter('month')" class="chart-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Monat</button>
                                    <button onclick="changeChartFilter('year')" class="chart-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Jahr</button>
                                    <button onclick="changeChartFilter('5years')" class="chart-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">5 Jahre</button>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <canvas id="casesChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Insert after canvas
        const canvas = document.getElementById('dashboardCanvas');
        canvas.insertAdjacentHTML('afterend', analyticsHTML);
        
        // Hide initially
        document.getElementById('analytics-dashboard').classList.add('hidden');
        
        // Load initial data
        setTimeout(() => {
            loadPositionStats();
            loadEmployeeAnalytics();
            initializeChart();
        }, 100);
    }

    function loadPositionStats() {
        const employees = loadEmployeesFromStorage();
        const juniorCount = employees.filter(e => e.position === 'junior').length;
        const sachbearbeiterCount = employees.filter(e => e.position === 'sachbearbeiter').length;
        const seniorCount = employees.filter(e => e.position === 'senior').length;

        const positions = [
            { title: 'Junior', count: juniorCount, avgTime: '45 Min', casesWeek: 28, color: 'blue' },
            { title: 'Lagerarbeiter', count: sachbearbeiterCount, avgTime: '35 Min', casesWeek: 42, color: 'green' },
            { title: 'Senior', count: seniorCount, avgTime: '25 Min', casesWeek: 56, color: 'purple' }
        ];

        const container = document.getElementById('position-stats');
        if (!container) return;

        container.innerHTML = positions.map(pos => `
            <div class="bg-gray-50 rounded-lg p-4 cursor-pointer hover:bg-gray-100 transition" onclick="showPositionDetails('${pos.title}')">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-700">${pos.title}</span>
                    <span class="bg-${pos.color}-100 text-${pos.color}-800 text-xs px-2 py-1 rounded-full">${pos.count} MA</span>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Ø Zeit:</span>
                        <span class="font-medium">${pos.avgTime}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Fälle/Woche:</span>
                        <span class="font-medium">${pos.casesWeek}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Store current filters for main employee list
    let currentEmploymentFilter = 'all';
    let currentPositionFilter = 'all';

    function loadEmployeeAnalytics(employmentFilter = null, positionFilter = null) {
        // Use provided filters or current stored filters
        if (employmentFilter !== null) currentEmploymentFilter = employmentFilter;
        if (positionFilter !== null) currentPositionFilter = positionFilter;

        const employees = loadEmployeesFromStorage();
        const container = document.getElementById('employee-analytics-list');
        if (!container) return;

        const positionLabels = {
            'junior': 'Junior',
            'lagerarbeiter': 'Lagerarbeiter',
            'senior': 'Senior',
            'experte': 'Experte'
        };

        const employmentTypeLabels = {
            'vollzeit': 'VZ',
            'teilzeit': 'TZ',
            'minijob': 'MJ'
        };

        const employmentTypeColors = {
            'vollzeit': 'bg-green-100 text-green-800',
            'teilzeit': 'bg-yellow-100 text-yellow-800',
            'minijob': 'bg-orange-100 text-orange-800'
        };

        // Apply both filters
        let filteredEmployees = employees;

        // Filter by employment type
        if (currentEmploymentFilter !== 'all') {
            filteredEmployees = filteredEmployees.filter(emp => emp.employmentType === currentEmploymentFilter);
        }

        // Filter by position
        if (currentPositionFilter !== 'all') {
            filteredEmployees = filteredEmployees.filter(emp => emp.position === currentPositionFilter);
        }

        container.innerHTML = filteredEmployees.map(emp => `
            <div class="bg-gray-50 rounded-lg p-4 cursor-pointer hover:bg-gray-100 transition" onclick="showEmployeeStats('${emp.name}')" data-employment-type="${emp.employmentType}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1">
                        <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold mr-3">
                            ${emp.avatar}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <p class="font-medium text-gray-900">${emp.name}</p>
                                <span class="px-1.5 py-0.5 text-xs font-medium rounded ${employmentTypeColors[emp.employmentType] || 'bg-gray-100 text-gray-800'}">
                                    ${employmentTypeLabels[emp.employmentType] || 'N/A'}
                                </span>
                            </div>
                            <p class="text-xs text-gray-500">${positionLabels[emp.position] || emp.position || 'Lagerarbeiter'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-gray-900">${emp.casesToday || Math.floor(Math.random() * 20 + 5)} Fälle</p>
                        <p class="text-xs text-gray-500">Heute</p>
                    </div>
                </div>
            </div>
        `).join('') || '<p class="text-gray-500 text-center py-4">Keine Mitarbeiter gefunden</p>';
    }

    function filterEmployeesByType(type) {
        // Update button styles
        const buttons = document.querySelectorAll('.employment-filter-btn');
        buttons.forEach(btn => {
            btn.className = 'employment-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600';
        });

        const activeBtn = document.getElementById(`filter-${type}`);
        if (activeBtn) {
            activeBtn.className = 'employment-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800';
        }

        // Reload employee list with employment filter
        loadEmployeeAnalytics(type, null);
    }

    function filterEmployeesByPosition(position) {
        // Update button styles
        const buttons = document.querySelectorAll('.position-main-filter-btn');
        buttons.forEach(btn => {
            btn.className = 'position-main-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600';
        });

        const activeBtn = document.getElementById(`position-filter-${position}`);
        if (activeBtn) {
            activeBtn.className = 'position-main-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800';
        }

        // Reload employee list with position filter
        loadEmployeeAnalytics(null, position);
    }

    function initializeChart() {
        const canvas = document.getElementById('casesChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        drawBarChart(ctx, 'day');
    }

    function drawBarChart(ctx, filter) {
        const canvas = ctx.canvas;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Sample data for different filters
        const data = {
            'day': [12, 15, 18, 14, 20, 16, 19, 22],
            'week': [85, 92, 78, 95, 88, 91, 83],
            'month': [320, 380, 350, 410, 390],
            'year': [3800, 4200, 4500, 4100],
            '5years': [15000, 16500, 17200, 18100, 19500]
        };
        
        const labels = {
            'day': ['9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'],
            'week': ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'],
            'month': ['Woche 1', 'Woche 2', 'Woche 3', 'Woche 4', 'Woche 5'],
            'year': ['Q1', 'Q2', 'Q3', 'Q4'],
            '5years': ['2019', '2020', '2021', '2022', '2023']
        };
        
        const values = data[filter] || data['day'];
        const barLabels = labels[filter] || labels['day'];
        const maxValue = Math.max(...values);
        
        const barWidth = (canvas.width - 60) / values.length - 10;
        const chartHeight = canvas.height - 60;
        
        // Draw bars
        values.forEach((value, index) => {
            const barHeight = (value / maxValue) * chartHeight;
            const x = 40 + index * (barWidth + 10);
            const y = canvas.height - 40 - barHeight;
            
            // Bar
            ctx.fillStyle = '#3B82F6';
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // Value label
            ctx.fillStyle = '#1F2937';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(value, x + barWidth/2, y - 5);
            
            // X-axis label
            ctx.fillText(barLabels[index], x + barWidth/2, canvas.height - 20);
        });
        
        // Y-axis
        ctx.strokeStyle = '#E5E7EB';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(30, 10);
        ctx.lineTo(30, canvas.height - 40);
        ctx.stroke();
        
        // X-axis
        ctx.beginPath();
        ctx.moveTo(30, canvas.height - 40);
        ctx.lineTo(canvas.width - 10, canvas.height - 40);
        ctx.stroke();
    }

    function changeChartFilter(filter) {
        // Update button styles
        const buttons = document.querySelectorAll('.chart-filter-btn');
        buttons.forEach(btn => {
            btn.className = 'chart-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600';
        });
        event.target.className = 'chart-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800';
        
        // Redraw chart
        const canvas = document.getElementById('casesChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            drawBarChart(ctx, filter);
        }
    }

    function showEmployeeStats(employeeName) {
        // Only show stats if analytics dashboard is visible
        const analyticsDiv = document.getElementById('analytics-dashboard');
        if (!analyticsDiv || analyticsDiv.classList.contains('hidden')) {
            return;
        }

        // Remove existing modal if any
        const existingModal = document.getElementById('employee-stats-modal');
        if (existingModal) {
            existingModal.remove();
        }

        // Create modal
        const modalHTML = `
            <div id="employee-stats-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-lg flex items-center justify-between">
                        <h2 class="text-xl font-bold">Mitarbeiter-Statistik: ${employeeName}</h2>
                        <button onclick="closeEmployeeStatsModal()" class="text-white hover:text-gray-200">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div class="p-6">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-1">Ø Bearbeitungszeit</p>
                                <p class="text-2xl font-bold text-gray-900">${Math.floor(Math.random() * 30 + 20)} Min</p>
                                <p class="text-xs text-green-600 mt-1">-5% vs. letzte Woche</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-1">Fälle diese Woche</p>
                                <p class="text-2xl font-bold text-gray-900">${Math.floor(Math.random() * 40 + 20)}</p>
                                <p class="text-xs text-blue-600 mt-1">+12% vs. letzte Woche</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-1">Erfolgsquote</p>
                                <p class="text-2xl font-bold text-gray-900">${Math.floor(Math.random() * 10 + 90)}%</p>
                                <p class="text-xs text-gray-500 mt-1">Sehr gut</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-1">Spezialisierung</p>
                                <p class="text-lg font-bold text-gray-900">Textilien, Accessoires</p>
                                <p class="text-xs text-gray-500 mt-1">2 Bereiche</p>
                            </div>
                        </div>

                        <div class="border-t pt-4">
                            <h3 class="font-semibold text-gray-900 mb-3">Performance-Verlauf (letzte 7 Tage)</h3>
                            <div class="h-32 bg-gray-50 rounded-lg flex items-end justify-around p-4">
                                ${[1,2,3,4,5,6,7].map(() => {
                                    const height = Math.floor(Math.random() * 80 + 20);
                                    return `<div class="bg-blue-500 rounded-t" style="width: 30px; height: ${height}%;"></div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeEmployeeStatsModal() {
        const modal = document.getElementById('employee-stats-modal');
        if (modal) {
            modal.remove();
        }
    }

    function showPositionDetails(position) {
        // Only show position details if analytics dashboard is visible
        const analyticsDiv = document.getElementById('analytics-dashboard');
        if (!analyticsDiv || analyticsDiv.classList.contains('hidden')) {
            return;
        }
        alert(`Detailansicht für ${position} - Weitere Statistiken können hier implementiert werden`);
    }

    // Position-specific chart functions
    function changePositionChartFilter(position, filter) {
        // Update button styles for this position
        const buttons = event.target.parentElement.querySelectorAll('.position-chart-filter-btn');
        buttons.forEach(btn => {
            btn.className = 'position-chart-filter-btn px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-600';
        });
        event.target.className = 'position-chart-filter-btn px-2 py-1 text-xs font-medium rounded bg-blue-100 text-blue-800';

        // Redraw chart for this position
        const canvas = document.getElementById(`${position}Chart`);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            drawBarChart(ctx, filter);
        }
    }

    function openComparisonModal() {
        // Remove existing modal if any
        const existingModal = document.getElementById('comparison-modal');
        if (existingModal) {
            existingModal.remove();
        }

        const modalHTML = `
            <div id="comparison-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-t-lg">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold">Analytics im Vergleich</h2>
                            <button onclick="closeComparisonModal()" class="text-white hover:text-gray-200">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 80px);">
                        <!-- Filter Section -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Filter auswählen</h3>

                            <!-- Employment Type Filter -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Beschäftigungsart</label>
                                <div class="flex flex-wrap gap-2">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="comparison-filter" data-type="employment" value="vollzeit" checked class="rounded border-gray-300 text-indigo-600">
                                        <span class="ml-2 text-sm">Vollzeit</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="comparison-filter" data-type="employment" value="teilzeit" checked class="rounded border-gray-300 text-indigo-600">
                                        <span class="ml-2 text-sm">Teilzeit</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="comparison-filter" data-type="employment" value="minijob" checked class="rounded border-gray-300 text-indigo-600">
                                        <span class="ml-2 text-sm">Minijob</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Time Period Filter -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Zeitraum</label>
                                <div class="flex gap-2">
                                    <button onclick="setComparisonPeriod('day')" class="comparison-period-btn px-3 py-1 text-sm rounded bg-indigo-100 text-indigo-800">Tag</button>
                                    <button onclick="setComparisonPeriod('week')" class="comparison-period-btn px-3 py-1 text-sm rounded bg-gray-100 text-gray-600">Woche</button>
                                    <button onclick="setComparisonPeriod('month')" class="comparison-period-btn px-3 py-1 text-sm rounded bg-gray-100 text-gray-600">Monat</button>
                                    <button onclick="setComparisonPeriod('year')" class="comparison-period-btn px-3 py-1 text-sm rounded bg-gray-100 text-gray-600">Jahr</button>
                                </div>
                            </div>

                            <!-- Position Filter -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Positionen</label>
                                <div class="flex flex-wrap gap-2">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="comparison-filter" data-type="position" value="junior" checked class="rounded border-gray-300 text-indigo-600">
                                        <span class="ml-2 text-sm">Junior</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="comparison-filter" data-type="position" value="sachbearbeiter" checked class="rounded border-gray-300 text-indigo-600">
                                        <span class="ml-2 text-sm">Lagerarbeiter</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="comparison-filter" data-type="position" value="senior" checked class="rounded border-gray-300 text-indigo-600">
                                        <span class="ml-2 text-sm">Senior</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="comparison-filter" data-type="position" value="experte" checked class="rounded border-gray-300 text-indigo-600">
                                        <span class="ml-2 text-sm">Experte</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Exclude Employees -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mitarbeiter ausschließen</label>
                                <div class="grid grid-cols-3 gap-2 max-h-32 overflow-y-auto p-2 border border-gray-200 rounded">
                                    ${loadEmployeesFromStorage().map(emp => `
                                        <label class="inline-flex items-center text-sm">
                                            <input type="checkbox" class="exclude-employee" value="${emp.id}" class="rounded border-gray-300 text-red-600">
                                            <span class="ml-1">${emp.name}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Team Comparison Toggle -->
                            <div class="mb-4">
                                <button onclick="toggleTeamComparison()" id="team-comparison-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                    <svg class="h-5 w-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                    Vergleich mit anderen Teams aktivieren
                                </button>
                            </div>

                            <!-- Team Selection (Initially Hidden) -->
                            <div id="team-selection" class="hidden mb-4 p-4 bg-gray-50 rounded-lg">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Team zum Vergleichen auswählen</label>
                                <select id="comparison-team" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">Team auswählen...</option>
                                    <option value="team-berlin">Team Berlin</option>
                                    <option value="team-munich">Team München</option>
                                    <option value="team-hamburg">Team Hamburg</option>
                                    <option value="team-frankfurt">Team Frankfurt</option>
                                    <option value="team-cologne">Team Köln</option>
                                </select>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div class="border-t pt-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Vergleichsergebnis</h3>
                                <button onclick="generateComparison()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                                    Vergleich generieren
                                </button>
                            </div>

                            <div id="comparison-results" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <!-- Comparison results will be loaded here -->
                                <div class="col-span-2 text-center text-gray-500 py-8">
                                    Wählen Sie Filter aus und klicken Sie auf "Vergleich generieren"
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeComparisonModal() {
        const modal = document.getElementById('comparison-modal');
        if (modal) {
            modal.remove();
        }
    }

    function toggleTeamComparison() {
        const teamSelection = document.getElementById('team-selection');
        const btn = document.getElementById('team-comparison-btn');

        if (teamSelection.classList.contains('hidden')) {
            teamSelection.classList.remove('hidden');
            btn.innerHTML = `
                <svg class="h-5 w-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Teamvergleich deaktivieren
            `;
            btn.classList.remove('bg-gray-100', 'text-gray-700');
            btn.classList.add('bg-indigo-100', 'text-indigo-700');
        } else {
            teamSelection.classList.add('hidden');
            btn.innerHTML = `
                <svg class="h-5 w-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                Vergleich mit anderen Teams aktivieren
            `;
            btn.classList.remove('bg-indigo-100', 'text-indigo-700');
            btn.classList.add('bg-gray-100', 'text-gray-700');
        }
    }

    function setComparisonPeriod(period) {
        const buttons = document.querySelectorAll('.comparison-period-btn');
        buttons.forEach(btn => {
            btn.className = 'comparison-period-btn px-3 py-1 text-sm rounded bg-gray-100 text-gray-600';
        });
        event.target.className = 'comparison-period-btn px-3 py-1 text-sm rounded bg-indigo-100 text-indigo-800';
    }

    function generateComparison() {
        const resultsContainer = document.getElementById('comparison-results');
        const teamSelection = document.getElementById('comparison-team').value;

        // Generate comparison data
        const ourTeamData = {
            avgCases: 125,
            avgTime: 32,
            successRate: 94,
            totalEmployees: 16
        };

        const otherTeamData = teamSelection ? {
            avgCases: 118,
            avgTime: 35,
            successRate: 91,
            totalEmployees: 14
        } : null;

        let resultsHTML = `
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold text-gray-800 mb-3">Unser Team</h4>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Ø Fälle/Tag:</span>
                        <span class="font-medium">${ourTeamData.avgCases}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Ø Bearbeitungszeit:</span>
                        <span class="font-medium">${ourTeamData.avgTime} Min</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Erfolgsquote:</span>
                        <span class="font-medium">${ourTeamData.successRate}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Mitarbeiter:</span>
                        <span class="font-medium">${ourTeamData.totalEmployees}</span>
                    </div>
                </div>
            </div>
        `;

        if (otherTeamData) {
            resultsHTML += `
                <div class="bg-white rounded-lg shadow p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">${document.getElementById('comparison-team').options[document.getElementById('comparison-team').selectedIndex].text}</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Ø Fälle/Tag:</span>
                            <span class="font-medium">${otherTeamData.avgCases}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Ø Bearbeitungszeit:</span>
                            <span class="font-medium">${otherTeamData.avgTime} Min</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Erfolgsquote:</span>
                            <span class="font-medium">${otherTeamData.successRate}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Mitarbeiter:</span>
                            <span class="font-medium">${otherTeamData.totalEmployees}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        resultsContainer.innerHTML = resultsHTML;
    }

    // Store current filters for each position
    const positionFilters = {
        'junior': 'all',
        'sachbearbeiter': 'all',
        'senior': 'all'
    };

    function filterPositionEmployees(position, employmentType) {
        // Update button styles
        const buttons = document.querySelectorAll(`.position-filter-btn-${position}`);
        buttons.forEach(btn => {
            btn.className = `position-filter-btn-${position} px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600`;
        });

        event.target.className = `position-filter-btn-${position} px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800`;

        // Store filter
        positionFilters[position] = employmentType;

        // Reload the list with filter
        loadPositionEmployeeLists();
    }

    function loadPositionEmployeeLists() {
        const employees = loadEmployeesFromStorage();

        // Group employees by position
        const positions = {
            'junior': [],
            'sachbearbeiter': [],
            'senior': []
        };

        const employmentTypeLabels = {
            'vollzeit': 'VZ',
            'teilzeit': 'TZ',
            'minijob': 'MJ'
        };

        const employmentTypeColors = {
            'vollzeit': 'bg-green-100 text-green-800',
            'teilzeit': 'bg-yellow-100 text-yellow-800',
            'minijob': 'bg-orange-100 text-orange-800'
        };

        employees.forEach(emp => {
            if (positions[emp.position]) {
                positions[emp.position].push(emp);
            }
        });

        // Update employee counts in headers
        const juniorCountEl = document.getElementById('junior-count');
        if (juniorCountEl) juniorCountEl.textContent = `${positions['junior'].length} Mitarbeiter`;

        const sachbearbeiterCountEl = document.getElementById('sachbearbeiter-count');
        if (sachbearbeiterCountEl) sachbearbeiterCountEl.textContent = `${positions['sachbearbeiter'].length} Mitarbeiter`;

        const seniorCountEl = document.getElementById('senior-count');
        if (seniorCountEl) seniorCountEl.textContent = `${positions['senior'].length} Mitarbeiter`;

        // Render each position list with the same design as main statistics
        Object.keys(positions).forEach(pos => {
            const container = document.getElementById(`${pos}-list`);
            if (container) {
                // Apply filter
                const filter = positionFilters[pos] || 'all';
                const filteredEmployees = filter === 'all'
                    ? positions[pos]
                    : positions[pos].filter(emp => emp.employmentType === filter);

                container.innerHTML = filteredEmployees.map(emp => `
                    <div class="bg-gray-50 rounded-lg p-4 cursor-pointer hover:bg-gray-100 transition" onclick="showEmployeeStats('${emp.name}')" data-employment-type="${emp.employmentType}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-1">
                                <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold mr-3">
                                    ${emp.avatar}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <p class="font-medium text-gray-900">${emp.name}</p>
                                        <span class="px-1.5 py-0.5 text-xs font-medium rounded ${employmentTypeColors[emp.employmentType] || 'bg-gray-100 text-gray-800'}">
                                            ${employmentTypeLabels[emp.employmentType] || 'N/A'}
                                        </span>
                                    </div>
                                    <p class="text-xs text-gray-500">${emp.abteilung || 'Keine Abteilung'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-gray-900">${emp.casesToday || Math.floor(Math.random() * 20 + 5)} Fälle</p>
                                <p class="text-xs text-gray-500">Heute</p>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p class="text-gray-500 text-sm text-center py-4">Keine Mitarbeiter in dieser Position</p>';
            }
        });

        // Initialize charts for each position (excluding experte)
        ['junior', 'sachbearbeiter', 'senior'].forEach(pos => {
            const canvas = document.getElementById(`${pos}Chart`);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                drawBarChart(ctx, 'day');
            }
        });
    }

    // Initialize views on page load
    window.addEventListener('DOMContentLoaded', () => {
        createEmployeeManagementView();
        createCaseManagementView();
        createAnalyticsDashboard();

        // Always reset with hardcoded data to ensure all properties are present
        localStorage.setItem('gevEmployees', JSON.stringify(mitarbeiterData));

        // Load and apply saved case assignments
        const isAutoAssigned = localStorage.getItem('autoAssignmentActive') === 'true';
        updateCasesTable(isAutoAssigned);
        refreshCaseEmployeeList();

        // Setup working hours visibility based on employment type
        setupWorkingHoursVisibility();
    });
</script>

</body>
</html>